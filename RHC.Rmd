---
title: "Case-study Right heart catheterization"
author: "Kexin Wang, M.S."
output:
  html_document:
    md_extensions: -startnum
    toc: yes
    toc_float:
      collapsed: yes
      smooth_scroll: no
  pdf_document:
    toc: yes
---


\newpage


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
knitr::opts_chunk$set(message = F)
knitr::opts_chunk$set(warning = F)

library(tableone)
library(tidyverse)
library(survival)
library(survminer)
library(GGally)
library(survRM2)
library(knitr)
#library(kableExtra)
#library(randomForestSRC)
library(ggRandomForests)
library(pROC)
#library(grpreg)
#library(pec)
library(ggfortify)
library(broom)
library(finalfit)
```


# Motivation

[Right heart catheterization(RHC)](https://www.hopkinsmedicine.org/healthlibrary/test_procedures/cardiovascular/right_heart_catheterization_135,40), also known as pulmonary artery catheterization, is an invasive test that mainly checks the working state of the heart by guiding a pulmonary artery (PA) catheter (a small and hollow tube) through the pulmonary artery and into the right chambers of the heart. Here is the video which enables you understand how it works.

<div align="center">
<iframe width="550" height="300" src="https://www.youtube.com/embed/xr-VkxUwceQ" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen>
</iframe>
</div>

It is often the case that a foreign objects enters the humen body, there is the risk of infection. RHC is no different. When the tube is put into the artery and a dye is injected into the heart, potential complications are the rupture of pulmonary artery, arrythmias of the heart where the heart may skip a beat. However, the widespread belief is that it is beneficial and safe, so it is difficult to design a randomized controlled trail(RCT). 

Without RCTs of RHC, the only way to evaluate its effectness is observational study. The motivation of this case study is to reveal the association between time to death in 30 days and RHC based on an observational dataset. The main predictor of the model is RHC, we also adjust the model with all the other variables in the dataset. We want to know whether RHC actually improves the patients' survival rate in 30 days adjusted by other baseline variables.


The libraries used in this study are listed in the following table, 
along with their purpose in this particular case study:

|Library|Purpose|
|---|--------------------------------------------------------------------------------------------------------------|


In order to run this code please ensure you have these packages installed. 

The learning objectives for this case study include:

  * propensity score matching
  * multivariate logistic regression
  * survival analysis
  

# What is the data?

[Right heart catheterization](http://biostat.mc.vanderbilt.edu/wiki/pub/Main/DataSets/rhc.csv): The dataset pertains to day 1 of hospitalization, i.e., the treatment variable `swang1` is whether or not a patient received an RHC (also called the Swan-Ganz catheter) on the first day in which the patient qualified for the study. The variable description can be found [here](http://biostat.mc.vanderbilt.edu/wiki/pub/Main/DataSets/rhc.html).


# Data Import

The data is an online resources, we will import data from the web directly  with `read_csv()` function.

```{r}
file <- "http://biostat.mc.vanderbilt.edu/wiki/pub/Main/DataSets/rhc.csv"
rhc <- read_csv(file)
```


# Data Wrangling

## Variable selection

There are totally `r ncol(rhc)` variables and `r nrow(rhc)` observations in the dataset. By reading the description of the data, we just want to select several variables here. When you try to reproduce this case study, you can try to choose others which you are interested in.  

```{r}
rhc_df <- 
  rhc %>% 
    select(age = age,
           sex = sex,
           race = race,
           education = edu,
           income = income,
           med_ins = ninsclas,
           disease = cat1,
           cancer = ca,
           weight = wtkilo1,
           temp = temp1,
           bp = meanbp1,
           resp = resp1,
           hrt = hrt1,
           pf = pafi1,
           pc = paco21,
           ph = ph1,
           death = dth30,
           time = t3d30,
           RHC = swang1)
#summary(rhc_df)
```

According to the [codebook](http://biostat.mc.vanderbilt.edu/wiki/pub/Main/DataSets/rhc.html),the description of variables we interested in is given below.

| variable names   |      meaning      |
|---------------------------------|---------------------------------|
| age                                  | Age                                                                                                                                                                 |
| sex                                  | Sex                                                                                                                                                                 |
| race                                 | Race                                                                                                                                                                |
| education                            | Years of education                                                                                                                                                  |
| income                               | Income                                                                                                                                                              |
| med_ins                              | Medical insurance                                                                                                                                                   |
| disease                              | Primary disease category                                                                                                                                            |
| cancer                               | Cancer                                                                                                                                                              |
| weight                               | Weight                                                                                                                                                              |
| temp                                 | Temperature                                                                                                                                                         |
| bp                                   | Mean blood pressure                                                                                                                                                 |
| resp                                 | Respiratory rate                                                                                                                                                    |
| rth                                  | Heart rate                                                                                                                                                          |
| pf                                   | PaO2/FIO2 ratio,ratio of arterial oxygen partial pressure to fractional inspired oxygen                                                                             |
| pc                                   | PaCo2 ratio,partial pressure of arterial carbon dioxide                                                                                                             |
| ph                                   | PH                                                                                                                                                                  |
| time                                 | Survival time of each patient in 30 days                                                                                                                            |
| death                                | Indicates whether the patient survived or dead in 30 days                                                                                                           |
| RHC                                  | Right heart catheterization |


# Exploratory data analysis

Our main topic is to investigate the influence of RHC, so let's devide the dataset into 'RHC' group and 'No RHC' group and try to find some difference between them. 

The table below will give us some characteristics of the data such as mean for numerical data, frequency for category data and p-value.


```{r}
explanatory = c ("age", "sex", "race", "education",
                 "income", "cancer", "weight", "temp", 
                 "bp","resp","hrt", "pf", "pc",
                 "ph", "death")

tblprint <- rhc_df %>%
  summary_factorlist('RHC', explanatory, p = TRUE)

#kable(tblprint, "html")
```
```{r}
tblprint2 <- CreateTableOne(data = rhc_df, strata = 'RHC') 

#kable(tblprint2, "html", caption = "Stritified by Right Heart Catheterization", booktabs = T) %>%
#  kable_styling('responsive')
```

The unadjusted outcomes indicate that patients managed with RHC were more likely to be white male, to have private insurance, to enter the study of ARF, MOSF or CHF. Patients with RHC were less likely to have cancer. 

## Data visualization

In order to further understand the difference between 'No RHC' and 'RHC' group, we would like to use `ggplot2` to create some plots.

```{r, fig.width=11, fig.height=5}
p1 <- rhc_df %>% 
        ggplot(aes(x = RHC, fill = sex)) + 
          geom_bar() + ggtitle('distribution of RHC')
p2 <- rhc_df %>% 
        ggplot(aes(x = RHC, fill = race)) + 
          geom_bar(position = "fill") + 
          ggtitle('distribution of RHC') + 
          ylab('proportion')

p3 <- rhc_df %>% 
        ggplot(aes(x = RHC, fill = death)) + 
          geom_bar(position = "fill") + 
          ggtitle('distribution of RHC') + 
          ylab('proportion')

ggarrange(p1, p2, p3, ncol=3, nrow=1)
```

```{r, fig.width=11, fig.height=5}
p4 <- rhc_df %>% 
        ggplot(aes(x = RHC, y = age, color = RHC)) + 
          geom_boxplot() + ggtitle('distribution of age')
p5 <- rhc_df %>% 
        ggplot(aes(x = RHC, y = bp, color = RHC)) + 
          geom_boxplot() + ggtitle('distribution of blood pressure')
p6 <- rhc_df %>% 
        ggplot(aes(x = RHC, y = pf, color = RHC)) + 
          geom_boxplot() + ggtitle('distribution of PaO2/FiO2')

         
ggarrange(p4, p5,p6, ncol=3, nrow=1)
```

# Data analysis

## Survival analysis

[survival analysis](https://en.wikipedia.org/wiki/Survival_analysis) is a branch of statistics for analyzing the expected duration of time until one or more events happen, such as death in biological organisms and failure in mechanical systems. 

## Outcome and time variables

Changing the type of the data is also very important for survival analysis, and by checking the data, we need to deal with variables denoted as characters. In our data set, the status of having RHC or not is not numeric. A way to adjust is to force it into factor directly. However, this kind of factor format sometimes does not work in some of the packages in R. Therefore, we pushed the character into a numeric number and deducted it by 1 to get the numeric denotation that we want.

Here we use function `as.numeric()`.

```{r}
rhc_df$death <- as.numeric(as.factor(rhc_df$death)) -1
rhc_df$RHC <- as.numeric(as.factor(rhc_df$RHC)) - 1
```

### Kaplan Meier (non-parametric)

The [Kaplan Meier estimator](https://en.wikipedia.org/wiki/Kaplan–Meier_estimator) is a non-parametric method used to estimate the survival probability. It is often used to estimate the survival rate stratified by some treatment of interest.

```{r}
fit <- survfit(Surv(time, death) ~ RHC, data = rhc_df)
fit
```

The total number of the patients having right catheterization is `r sum(rhc_df$RHC == 1, na.rm = TRUE)`, and `r sum(rhc_df$RHC == 1, na.rm = TRUE)-fit$n.censor[58]` of them died in 30 days(38%). The total number of the patients not having right catheterization is `r sum(rhc_df$RHC == 0, na.rm = TRUE)`, and `r sum(rhc_df$RHC == 0, na.rm = TRUE) - fit$n.censor[29]` of them died in 30 days(30.6%).

```{r}
res.sum <- surv_summary(fit)
```

* time: the time points on the curve.
* n.risk: the number of subjects at risk at time t
* n.event: the number of events that occurred at time t.
* n.censor: the number of censored subjects, who exit the risk set, without an event, at time t.
* surv: estimate of survival probability.
* std.err: standard error of survival.
* upper: upper end of confidence interval
* lower: lower end of confidence interval
* strata: indicates stratification of curve estimation. If strata is not NULL, there are multiple curves in the result. The levels of strata (a factor) are the labels for the curves.

```{r}
autoplot(fit, conf.int = FALSE) +
  labs(title = 'Kaplan Meier Plot', 
       y = 'survival probability', color = 'RHC', fill = 'RHC') +
  theme_bw() +
  scale_color_manual(labels = c("No RHC", "Yes RHC"), values = c("red", "blue"))
```

The Kaplan Meier plot shows us the survival rate stratified by having the RHC without any covariates adjustment.

The x-axis is the survival time, and the y-axis is the survival probability. It looks like a step function since the probability changes each day(the data only record the event daily).

Some of the description of the plot: at the beginning, all the patients survived. The survival probability of patients having the right catheterization is about `r fit$n.censor[58]/sum(rhc_df$RHC == 1, na.rm = TRUE)` and `r fit$n.censor[29]/sum(rhc_df$RHC == 0, na.rm = TRUE)` for patients not having the right catheterization. 


## Propensity socre

In the statistical analysis of observational data, [propensity score matching (PSM)](https://en.wikipedia.org/wiki/Propensity_score_matching) is a statistical matching technique that attempts to estimate the effect of a treatment, policy, or other intervention by accounting for the covariates that predict receiving the treatment. PSM attempts to reduce the bias due to confounding variables that could be found in an estimate of the treatment effect obtained from simply comparing outcomes among units that received the treatment versus those that did not. 

As we mentioned above, RHC is beneficial is the popular belief, which makes it harder to build a RCT. In ovservational studies, the treatment selection is confounded with patients   






#```{r}
#rmst <- rmst2(rhc_df$t3d30, rhc_df$death, arm = rhc_df$RHC, tau = 30, covariates = NULL)
#
#rmst$unadjusted.result %>%
#  tidy() -> tbl.rmst
#
#tbl.rmst %>%
#  mutate(CI = paste('(',signif(lower..95,3), ',',signif(upper..95,3),')')) -> tbl.rmst
#
#tbl.rmst <- tbl.rmst[,c(1,2,6,5)]
#colnames(tbl.rmst) <- c('Comparision', 'Estiamte', '95% CI', 'P-value')
#tbl.rmst$`P-value`[tbl.rmst$`P-value` < 0.001] <- '<0.001'
#tbl.rmst$Estiamte <- signif(tbl.rmst$Estiamte, 3)
#kable(tbl.rmst[c(1,2),], "html", caption = "Restricted mean survival time", booktabs = T) %>%  #kable_styling('responsive')
#  
#
#```



The results show that having RHC decrease the patients' restricted mean survival time by 1.5 days. It seems that RHC is causing patients to live less long. However, it's the result without any covariate adjustment. What if we want to adjust the model by the variables that we are interested in?



# Proportional Hazard Model (Cox model)

In logistic regression, we know that whether an event is going to happen or not, and you could see survival analysis as an updated version of logistic regression where you could see when that even would happen.

Cox model, also known as proportional hazards models are a class of parametric survival models in statistics. It includes variables like the time that passes, the event occurs and other covariates that used to adjust the association of survival rate and time.

A fundamental assumption of the cox model is that the model assumes the hazard is constant with the time passing by.

### 1. Right censoring

We would only introduce right censoring in our case study, for the right censoring, we know that the patients are even-free up until the censoring time.

### 2. How do we record survival data

+ T = time to death

+ C = censoring time

However, we can only observe the $Y = min(C, T)$

it means that whether the patients dead or they drop the experiment


### 3. Survival Function

$$S(t) = P(T>t) = 1 - F(t)$$


To simplify, the survival rate equal to the probability of surviving at time t or one minus the probability of dying at time t



### 4. Hazard Function

$$H(t) = P(T = t|T \ge t)$$

It means that 

$$H(t) = \frac{number~ of~ individuals~ experiencing~ an~ event~ in~ interval~ beginning~ at~ t}{an~ event~ in~ interval~ beginning~ at~ time t \times (interval~ width)}$$

$$H(t) = \frac{f(t)}{S(t-1)}$$


wehre $f(t) = p(t=T)$


### 5. Proporites

+ non-increasing

+ survival rate at time 0 equal to 1

+ survival probability at time infinity equal to 0

+ the hazard function assumes proportional hazard meaning that the hazard is constant


We esitmate the hazard by the function:

$$H(t) = H_0(t) e^{\beta X}$$

where $\beta$ is the coefficients matrix and the X is the covariates matrix.





#```{r}
#fit1 <- coxph(Surv(t3d30,death) ~ . + .^2 ,data = rhc_df)
#
#```


We fit the model with all the variables and their pairwise interactions. Since we have too many variables, we won't interpret each of them. Just notice that if the coefficient is larger than 0, the variable will increase the survival probability and vice versa.


### 6. Adjusted Survival Plot

We could estimate the new survival plot by inputting the main predictor RHC, we first code all RHC as 0, predict the survival rate and input all RHC as 1, and predict the survival rate again.



#```{r}
#rhc0 <- RHC <- rhc_df
#rhc0$RHC <- 0
#RHC$RHC <- 1
#```



After extracting the survival rate, we can see that the effect of Right Heart Catheterization changed. The survival rate of the patients having the RHC is actually higher than those who don't have RHC. The red line is now above the blue line.




#```{r}
#time1 <- survfit(fit1, newdata = rhc0)$surv
#time2 <- survfit(fit1, newdata = RHC)$surv
#
#
#dat.time <- data.frame(time1 = rowMeans(time1), time2 = rowMeans(time2))
#ggplot(dat.time) +
#  geom_step(aes(x =1:length(dat.time$time1) ,y = time1, col = 'red')) +
#  geom_step(aes(x =1:length(dat.time$time2) ,y = time2, col = 'blue')) +
#  theme_survminer() +
#  theme_minimal() + labs(colour="Strata", x = "survival time", y = "probability", colour = 'RHC',  title = #'Survival Plot') +
#  scale_color_manual(labels = c("Yes RHC", "No RHC"), values = c("red", "blue"))
#
#  
#
#
#```




#```{r}
#meantime2 <- signif(mean(dat.time$time2) * 30 ,3)
#uptime2 <- signif(quantile(dat.time$time2, 0.975) ,3)
#lowtime2 <- signif(quantile(dat.time$time2, 0.025), 3)
#
#meantime1 <- signif(mean(dat.time$time1) * 30 ,3)
#uptime1 <- signif(quantile(dat.time$time1, 0.975), 3)
#lowtime1 <- signif(quantile(dat.time$time1, 0.025), 3)
#
#meantime2 - meantime1
#
#tbl.rmst$Estiamte <- c(meantime2 - meantime1, signif(meantime2 / meantime1,3), NA)
#tbl.rmst$`95% CI` <- c( paste('(', signif(lowtime2 - lowtime1,3), ',', (uptime2 - uptime1),')'), #paste('(', signif(lowtime2 / lowtime1,3), ',', signif(uptime2 / uptime1,3),')'), NA)
#
#
#kable(tbl.rmst[c(1,2),c(1,2,3)], "html", caption = "Restricted mean survival time", booktabs = T) %>%  #kable_styling('responsive')
#```


After adjusting the covariates that we already have had, having RHC decreased the mean survival time of the patients by 0.9 days. Comparing to the result with no adjustment, the decrease of the days decreased 0.6 days, Which means the result after adjusting all covariates show that RHC is less harmful than without modification.




# Reference



Lin DY, Psaty BM, Kronmal RA (1998): Assessing the sensitivity of regression results to unmeasured confounders in observational studies. Biometrics 54:948-963 for useful methods for sensitivity analysis, one of which was applied to the RHC results.


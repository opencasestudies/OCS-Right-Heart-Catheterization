---
title: "Case-study Right heart catheterization"
author: "Hanchao Zhang, M.S."
output:
  html_document:
    md_extensions: -startnum
    toc: yes
    toc_float:
      collapsed: yes
      smooth_scroll: no
  pdf_document:
    toc: yes
---


\newpage


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
knitr::opts_chunk$set(message = F)
knitr::opts_chunk$set(warning = F)

library(tableone)
library(tidyverse)
library(survival)
library(survminer)
library(GGally)
library(survRM2)
library(knitr)
library(kableExtra)
library(randomForestSRC)
library(ggRandomForests)
library(pROC)
library(grpreg)
library(pec)
library(ggfortify)
library(survRM2)
library(kableExtra)
library(broom)
```


## Motivation

[Right heart catheterization(RHC)](https://www.hopkinsmedicine.org/healthlibrary/test_procedures/cardiovascular/right_heart_catheterization_135,40), also known as pulmonary artery catheterization, is an invasive test that mainly checks the working state of the heart by guiding a pulmonary artery (PA) catheter (a small and hollow tube) through the pulmonary artery and into the right chambers of the heart. 

The motivation of the analysis is to reveal the association between time to death in 30 days and right heart catheterization (RHC). The main predictor of the model is right heart catheterization, we also adjust the model with all the other variables in the dataset. We want to know whether right heart catheterization actually improves the patients' survival rate in 30 days adjusted by other baseline variables.


Even though receiving RHC had decreased survival time in general, the unmeasured confounders can partly explain the results.




## What is the data?

[http://biostat.mc.vanderbilt.edu/wiki/pub/Main/DataSets/rhc.html](http://biostat.mc.vanderbilt.edu/wiki/pub/Main/DataSets/rhc.html)


The dataset pertains to day 1 of hospitalization, i.e., the "treatment" variable swang1 is whether or not a patient received an RHC (also called the Swan-Ganz catheter) on the first day in which the patient qualified for the SUPPORT study (see above). 





| variable names   |      meaning      |
|---------------------------------|---------------------------------|
| Age                                  | Age                                                                                                                                                                 |
| Sex                                  | Sex                                                                                                                                                                 |
| Race                                 | Race                                                                                                                                                                |
| Edu                                  | Years of education                                                                                                                                                  |
| Income                               | Income                                                                                                                                                              |
| Ninsclas                             | Medical insurance                                                                                                                                                   |
| Cat1                                 | Primary disease category                                                                                                                                            |
| Cat2                                 | Secondary disease category                                                                                                                                          |
| Categories of admission diagnosis:   |                                                                                                                                                                     |
| Resp                                 | Respiratory Diagnosis                                                                                                                                               |
| Card                                 | Cardiovascular Diagnosis                                                                                                                                            |
| Neuro                                | Neurological Diagnosis                                                                                                                                              |
| Gastr                                | Gastrointestinal Diagnosis                                                                                                                                          |
| Renal                                | Renal Diagnosis                                                                                                                                                     |
| Meta                                 | Metabolic Diagnosis                                                                                                                                                 |
| Hema                                 | Hematologic Diagnosis                                                                                                                                               |
| Seps                                 | Sepsis Diagnosis                                                                                                                                                    |
| Trauma                               | Trauma Diagnosis                                                                                                                                                    |
| Ortho                                | Orthopedic Diagnosis                                                                                                                                                |
|                                      |                                                                                                                                                                     |
| Adld3p                               | ADL                                                                                                                                                                 |
| Das2d3pc                             | DASI ( Duke Activity Status Index)                                                                                                                                  |
| Dnr1                                 | DNR status on day1                                                                                                                                                  |
| Ca                                   | Cancer                                                                                                                                                              |
| Surv2md1                             | Support model estimate of the prob. of surviving 2 months                                                                                                           |
| Aps1                                 | APACHE score                                                                                                                                                        |
| Scoma1                               | Glasgow Coma Score                                                                                                                                                  |
| Wtkilo1                              | Weight                                                                                                                                                              |
| Temp1                                | Temperature                                                                                                                                                         |
| Meanbp1                              | Mean blood pressure                                                                                                                                                 |
| Resp1                                | Respiratory rate                                                                                                                                                    |
| Hrt1                                 | Heart rate                                                                                                                                                          |
| Pafi1                                | PaO2/FIO2 ratio                                                                                                                                                     |
| Paco21                               | PaCo2                                                                                                                                                               |
| Ph1                                  | PH                                                                                                                                                                  |
| Wblc1                                | WBC                                                                                                                                                                 |
| Hema1                                | Hematocrit                                                                                                                                                          |
| Sod1                                 | Sodium                                                                                                                                                              |
| Pot1                                 | Potassium                                                                                                                                                           |
| Crea1                                | Creatinine                                                                                                                                                          |
| Bili1                                | Bilirubin                                                                                                                                                           |
| Alb1                                 | Albumin                                                                                                                                                             |
| Urin1                                | Urine output                                                                                                                                                        |
| Categories of comorbidities illness: |                                                                                                                                                                     |
| Cardiohx                             | Acute MI, Peripheral Vascular Disease, Severe Cardiovascular Symptoms (NYHA-Class III), Very Severe Cardiovascular Symptoms (NYHA-Class IV)                         |
| Chfhx                                | Congestive Heart Failure                                                                                                                                            |
| Dementhx                             | Dementia, Stroke or Cerebral Infarct, Parkinson’s Disease                                                                                                           |
| Psychhx                              | Psychiatric History, Active Psychosis or Severe Depression                                                                                                          |
| Chrpulhx                             | Chronic Pulmonary Disease, Severe Pulmonary Disease, Very Severe Pulmonary Disease                                                                                  |
| Renalhx                              | Chronic Renal Disease, Chronic Hemodialysis or Peritoneal Dialysis                                                                                                  |
| Liverhx                              | Cirrhosis, Hepatic Failure                                                                                                                                          |
| Gibledhx                             | Upper GI Bleeding                                                                                                                                                   |
| Malighx                              | Solid Tumor, Metastatic Disease, Chronic Leukemia/Myeloma, Acute Leukemia, Lymphoma                                                                                 |
| Immunhx                              | Immunosupperssion, Organ Transplant, HIV Positivity, Diabetes Mellitus Without End Organ Damage, Diabetes Mellitus With End Organ Damage, Connective Tissue Disease |
| Transhx                              | Transfer (> 24 Hours) from Another Hospital                                                                                                                         |
| Amihx                                | Definite Myocardial Infarction                                                                                                                                      |
|                                      |                                                                                                                                                                     |
| Swang1                               | Right Heart Catheterization (RHC)                                                                                                                                   |
| Sadmdte                              | Study Admission Date                                                                                                                                                |
| Dthdte                               | Date of Death                                                                                                                                                       |
| Lstctdte                             | Date of Last Contact                                                                                                                                                |
| Dschdte                              | Hospital Discharge Date                                                                                                                                             |
| Death                                | Death at any time up to 180 Days                                                                                                                                    |
| Ptid                                 | Patient ID                



## Data Import

The followings are some of the libraries that we will use later in our analysis.



```{r}
library(tableone)
library(tidyverse)
library(survival)
library(survminer)
library(GGally)
library(survRM2)
library(knitr)
library(kableExtra)
library(randomForestSRC)
library(ggRandomForests)
library(pROC)
library(grpreg)
library(pec)
```


We import the effectiveness of RHC in the initial care of critically ill patients dataset. 




```{r}
rhc <- read.csv('/Users/hanchao/Desktop/rhc.csv')
rhc <- rhc[,-1]
head(rhc)[,1:12]
```




By reading the description of the data, we need to exclude several variables in the dataset. The variables including all the enrollment time, discharge time and so on, and the variables with the percentage of the missing value larger than 20% are also excluded (We choose 20% as an arbitrary number since we do not want to lose too much information from the whole data set).



The variables that we excluded：

| Vairbale Name | Meaning |
|---------------|---------------------------------------------|
| ptid       | Patient ID         |
| cat2          | Secondary disease category         |
| sadmdte       | Study Admission Date         |
| dschdte       | Hospital Discharge Date         |
| dthdte       | Date of Death         |
| lstctdte       | Date of Last Contact        |
| death       |     Death at any time up to 180 Days    |
| surv2md1       |    Support model estimate of the prob. of surviving 2 months |



```{r}
rhc <- read.csv('/Users/hanchao/Desktop/rhc.csv')
rhc <- rhc[,-1]
var.vector <- c(
"cat2",
"sadmdte",
"dschdte",
"dthdte",
"lstctdte",
"death",
"surv2md1",
"ptid"
)
var.which <- NULL
for (i in var.vector) {
  var.which[i] <- which(names(rhc) == i)
}
var.which2 <- NULL
for (i in names(rhc)) {
  if( sum(is.na(rhc[,i]))/nrow(rhc) > 0.2 ){
    var.which2[i] <- which(names(rhc) == i)
  }
}

rhc_DF <- rhc[,-c(var.which, var.which2)]
```



## Data Wrangling

### 1. Check the type of the data

We can print the summary and the type of data first to take a look at the dataset. The summary of the data will give us some characteristics of the data such as mean, median quantiles, and frequency.

The type of data can show us whether the variable is stored as factor, string, int or number.



```{r}
summary(rhc_DF)[,1:12]
```



### 2. Outcome and time variables

Changing the type of the data is also very important for survival analysis, and by checking the data, we also sometimes need to deal with variables denoted as characters. In our data set, the status of having RHC or not is not numeric. A way to adjust is to force it into factor directly. However, this kind of factor format sometimes does not work in some of the packages in R. Therefore, we pushed the character into a numeric number and deducted it by 1 to get the numeric denotation that we want.


We also used an easy way to change all the variable type to the right one by using a loop. The main idea is that after observing the summary of the data, we can approximately say that the variables with mean larger than five should be continuous variables, the others should be binary or other factors with more levels instead.


```{r}
for (i in names(rhc_DF)) {
  if(is.numeric(rhc_DF[,i])){
    if(mean(rhc_DF[,i], na.rm = T) < 5){
      rhc_DF[,i] <- as.factor((rhc_DF[,i]))
    }else{
      rhc_DF[,i] <- ((rhc_DF[,i]))
    }
  }
}

rhc_DF$dth30 <- as.numeric(rhc_DF$dth30) - 1
rhc_DF$swang1 <- as.numeric(rhc_DF$swang1) - 1
rhc_DF$alb1 <- as.numeric(as.character(rhc_DF$alb1))

rhc_DF$bili1 <- as.numeric(as.character(rhc_DF$bili1))
rhc_DF$crea1 <-  as.numeric(as.character(rhc_DF$crea1))
rhc_DF$pot1 <- as.numeric(as.character(rhc_DF$pot1))
```


## Exploratory data analysis

For the numeric variables, we should check the usually before doing any test. QQ-plot is an easy way to test normality, there are several tests, Shapiro, for example. However, we won't use other tests except for QQ-plot here.



```{r, fig.height=7}
nonnormal <- NULL
par(mfrow = c(4,6))
for (i in 1:ncol(rhc_DF)) {
  if( is.numeric(rhc_DF[,i]) ){
    qqnorm(rhc_DF[,i], main = names(rhc_DF)[i])
    qqline(rhc_DF[,i])
    nonnormal[i] <- names(rhc_DF)[i]
  }
}
```


Basically, all of the numeric variables are not normally distributed. It matters to the demography analysis in the later part of our study since we would use Wilcoxon test instead of t-test later.





### 1. Demographic

**Stratified by Right Heart Catheterization**



```{r, results='hide'}
CreateTableOne(data = rhc_DF, strata = 'swang1') %>%
  print(nonnormal = nonnormal) -> tblprint2

tblprint2[c(2, 12, 16:27, 29, 52:53, 60:70, 74),4] <- 'Chi-sq'
tblprint2[,4][tblprint2[,4] == 'nonnorm'] <- 'Wilcoxon'
```



```{r}
kable(tblprint2 [-c(30,39),], "html", caption = "Stritified by Right Heart Catheterization", booktabs = T) %>%
  kable_styling('responsive') %>%
  add_indent(c(3:11, 13:15,52:57,69:71,73:76 ))

```



The demographics can help us understand the one to one relation between right heart catheterization and other symptoms. 




**Stratified by death in 30 days**


```{r, results='hide'}
CreateTableOne(data = rhc_DF, strata = 'dth30') %>%
  print(nonnormal = nonnormal) -> tblprint2

tblprint2[c(2, 12, 16:27, 29, 52:53, 60:70, 74),4] <- 'Chi-sq'
tblprint2[,4][tblprint2[,4] == 'nonnorm'] <- 'Wilcoxon'
```

```{r}
kable(tblprint2 [-c(30,39),], "html", caption = "Stritified by death in 30 days", booktabs = T) %>%
  kable_styling('responsive') %>%
  add_indent(c(3:11, 13:15,52:57,69:71,73:76 ))

```



With the two tables above, we know that most of the covariates that we have already included in our dataset are associated with both death in 30 days and having the right catheterization or not. That makes them as confounders in our study.

### 2. Data visulization


```{r, fig.height=7}
visu_rhc_DF <- rhc_DF
visu_rhc_DF$swang1 <- as.factor(visu_rhc_DF$swang1)
visu_rhc_DF$dth30 <- as.factor(visu_rhc_DF$dth30)
ggpairs(visu_rhc_DF[,c('swang1','age', 'sex', 'race', 'chfhx', 'amihx', 'dementhx', 'dth30')], columnLabels = c('RHC','age', 'sex', 'race', 'Congestive Heart Failure', 'Definite Myocardial Infarction', 'Dementia, Stroke or Cerebral Infarct, Parkinson’s Disease', 'death in 30 days'))

```



The ggpair is a good way of visualizing the data, and we choose some variables to make the visualization. 

After demographic analysis, we got that the p-value, and we know there are associations, the visualization helps us to understand better what the associations look like. 

The plots on the diagonal are the distribution of variables, and plots on the sides next to the diagonal are the associations between two selected variables.


### 3. Kaplan Meier (non-parametric)


The Kaplan Meier estimator is a non-parametric method used to estimate the survival probability. It is often used to estimate the survival rate stratified by some treatment of interest.




```{r}
fit <- survfit(Surv(t3d30, dth30) ~ swang1, data = rhc_DF)
fit
```



The t3d30 is the survival time of each patient and dth30 is the dummy variable that indicates whether the patient survived or dead in 30 days.

The total number of the patients having right catheterization is 2184, and 830 of them died in 30 days(38%). The total number of the patients not having right catheterization is 3551, and 1088 of them died in 30 days(30.6%).




```{r}

autoplot(fit, conf.int = FALSE) +
  labs(title = 'Kaplan Meier Plot', y = 'survival probability', color = 'RHC', fill = 'RHC') +
  theme_bw() +
  scale_color_manual(labels = c("No RHC", "Yes RHC"), values = c("red", "blue"))

```





The Kaplan Meier plot shows us the survival rate stratified by having the right heart catheterization without any covariates adjustment.

The x-axis is the survival time, and the y-axis is the survival probability. It looks like a step function since the probability changes each day(the data only record the event daily).

Some of the description of the plot: at the beginning, all the patients survived. The survival probability of patients having the right catheterization is about 62.00% and 69.36% for patients not having the right catheterization. 




```{r}
rmst <- rmst2(rhc_DF$t3d30, rhc_DF$dth30, arm = rhc_DF$swang1, tau = 30, covariates = NULL)

rmst$unadjusted.result %>%
  tidy() -> tbl.rmst

tbl.rmst %>%
  mutate(CI = paste('(',signif(lower..95,3), ',',signif(upper..95,3),')')) -> tbl.rmst

tbl.rmst <- tbl.rmst[,c(1,2,6,5)]
colnames(tbl.rmst) <- c('Comparision', 'Estiamte', '95% CI', 'P-value')
tbl.rmst$`P-value`[tbl.rmst$`P-value` < 0.001] <- '<0.001'
tbl.rmst$Estiamte <- signif(tbl.rmst$Estiamte, 3)
kable(tbl.rmst[c(1,2),], "html", caption = "Restricted mean survival time", booktabs = T) %>%  kable_styling('responsive')
  

```



The results show that having RHC decrease the patients' restricted mean survival time by 1.5 days. It seems that RHC is causing patients to live less long. However, it's the result without any covariate adjustment. What if we want to adjust the model by the variables that we are interested in?



## Proportional Hazard Model (Cox model)

In logistic regression, we know that whether an event is going to happen or not, and you could see survival analysis as an updated version of logistic regression where you could see when that even would happen.

Cox model, also known as proportional hazards models are a class of parametric survival models in statistics. It includes variables like the time that passes, the event occurs and other covariates that used to adjust the association of survival rate and time.

A fundamental assumption of the cox model is that the model assumes the hazard is constant with the time passing by.

### 1. Right censoring

We would only introduce right censoring in our case study, for the right censoring, we know that the patients are even-free up until the censoring time.

### 2. How do we record survival data

+ T = time to death

+ C = censoring time

However, we can only observe the $Y = min(C, T)$

it means that whether the patients dead or they drop the experiment


### 3. Survival Function

$$S(t) = P(T>t) = 1 - F(t)$$


To simplify, the survival rate equal to the probability of surviving at time t or one minus the probability of dying at time t



### 4. Hazard Function

$$H(t) = P(T = t|T \ge t)$$

It means that 

$$H(t) = \frac{number~ of~ individuals~ experiencing~ an~ event~ in~ interval~ beginning~ at~ t}{an~ event~ in~ interval~ beginning~ at~ time t \times (interval~ width)}$$

$$H(t) = \frac{f(t)}{S(t-1)}$$


wehre $f(t) = p(t=T)$


### 5. Proporites

+ non-increasing

+ survival rate at time 0 equal to 1

+ survival probability at time infinity equal to 0

+ the hazard function assumes proportional hazard meaning that the hazard is constant


We esitmate the hazard by the function:

$$H(t) = H_0(t) e^{\beta X}$$

where $\beta$ is the coefficients matrix and the X is the covariates matrix.





```{r}
fit1 <- coxph(Surv(t3d30,dth30) ~ . + .^2 ,data = rhc_DF)

```


We fit the model with all the variables and their pairwise interactions. Since we have too many variables, we won't interpret each of them. Just notice that if the coefficient is larger than 0, the variable will increase the survival probability and vice versa.


### 6. Adjusted Survival Plot

We could estimate the new survival plot by inputting the main predictor RHC, we first code all RHC as 0, predict the survival rate and input all RHC as 1, and predict the survival rate again.



```{r}
rhc0 <- rhc1 <- rhc_DF
rhc0$swang1 <- 0
rhc1$swang1 <- 1
```



After extracting the survival rate, we can see that the effect of Right Heart Catheterization changed. The survival rate of the patients having the RHC is actually higher than those who don't have RHC. The red line is now above the blue line.




```{r}
time1 <- survfit(fit1, newdata = rhc0)$surv
time2 <- survfit(fit1, newdata = rhc1)$surv


dat.time <- data.frame(time1 = rowMeans(time1), time2 = rowMeans(time2))
ggplot(dat.time) +
  geom_step(aes(x =1:length(dat.time$time1) ,y = time1, col = 'red')) +
  geom_step(aes(x =1:length(dat.time$time2) ,y = time2, col = 'blue')) +
  theme_survminer() +
  theme_minimal() + labs(colour="Strata", x = "survival time", y = "probability", colour = 'RHC',  title = 'Survival Plot') +
  scale_color_manual(labels = c("Yes RHC", "No RHC"), values = c("red", "blue"))

  


```




```{r}
meantime2 <- signif(mean(dat.time$time2) * 30 ,3)
uptime2 <- signif(quantile(dat.time$time2, 0.975) ,3)
lowtime2 <- signif(quantile(dat.time$time2, 0.025), 3)

meantime1 <- signif(mean(dat.time$time1) * 30 ,3)
uptime1 <- signif(quantile(dat.time$time1, 0.975), 3)
lowtime1 <- signif(quantile(dat.time$time1, 0.025), 3)

meantime2 - meantime1

tbl.rmst$Estiamte <- c(meantime2 - meantime1, signif(meantime2 / meantime1,3), NA)
tbl.rmst$`95% CI` <- c( paste('(', signif(lowtime2 - lowtime1,3), ',', (uptime2 - uptime1),')'), paste('(', signif(lowtime2 / lowtime1,3), ',', signif(uptime2 / uptime1,3),')'), NA)


kable(tbl.rmst[c(1,2),c(1,2,3)], "html", caption = "Restricted mean survival time", booktabs = T) %>%  kable_styling('responsive')
```


After adjusting the covariates that we already have had, having RHC decreased the mean survival time of the patients by 0.9 days. Comparing to the result with no adjustment, the decrease of the days decreased 0.6 days, Which means the result after adjusting all covariates show that RHC is less harmful than without modification.




### Reference



Lin DY, Psaty BM, Kronmal RA (1998): Assessing the sensitivity of regression results to unmeasured confounders in observational studies. Biometrics 54:948-963 for useful methods for sensitivity analysis, one of which was applied to the RHC results.


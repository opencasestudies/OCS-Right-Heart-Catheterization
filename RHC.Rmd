---
title: "Case-study Right heart catheterization"
author: "Open Case Study Team"
output:
  html_document:
    md_extensions: -startnum
    toc: yes
    toc_float:
      collapsed: yes
      smooth_scroll: no
  pdf_document:
    toc: yes
---


\newpage


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
knitr::opts_chunk$set(message = F)
knitr::opts_chunk$set(warning = F)

library(tableone)
library(tidyverse)
library(survival)
library(survminer)
library(GGally)
library(survRM2)
library(knitr)
library(kableExtra)
library(ggRandomForests)
library(pROC)
library(ggfortify)
library(broom)
library(finalfit)
library(MatchIt)
```


# Motivation

[Right heart catheterization(RHC)](https://www.hopkinsmedicine.org/healthlibrary/test_procedures/cardiovascular/right_heart_catheterization_135,40), also known as pulmonary artery catheterization, is an invasive test that mainly checks the working state of the heart by guiding a pulmonary artery (PA) catheter (a small and hollow tube) through the pulmonary artery and into the right chambers of the heart. Here is the video which enables you to understand how it works.

<div align="center">
<iframe width="550" height="300" src="https://www.youtube.com/embed/xr-VkxUwceQ" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen>
</iframe>
</div>

<center>
[source: https://www.youtube.com/embed/xr-VkxUwceQ ]
</center>

It is often the case that a foreign objects enters the humen body, there is the risk of infection. RHC is no different. When the tube is put into the artery and a dye is injected into the heart, potential complications are the rupture of pulmonary artery, arrythmias of the heart where the heart may skip a beat. However, the widespread belief is it beneficial and safe makes it difficult to design a randomized controlled trail(RCT). 

Without RCTs of RHC, the only way to evaluate its effectness is observational study. The motivation of this case study is to reveal the association between time to death in 30 days and RHC based on an observational dataset. The main predictor of the model is RHC, we also adjust the model with all the other variables in the dataset. We want to know whether RHC actually improves the patients' survival rate in 30 days adjusted by other baseline variables.


The libraries used in this study are listed in the following table, 
along with their purpose in this particular case study:

|Library|Purpose|
|---|--------------------------------------------------------------------------------------------------------------|


In order to run this code please ensure you have these packages installed. 

The learning objectives for this case study include:

  * causal inference
  * propensity score matching
  * multivariate logistic regression
  * survival analysis
  

# What is the data?

[Right heart catheterization](http://biostat.mc.vanderbilt.edu/wiki/pub/Main/DataSets/rhc.csv): The dataset pertains to day 1 of hospitalization, i.e., the treatment variable `swang1` is whether or not a patient received an RHC (also called the Swan-Ganz catheter) on the first day in which the patient qualified for the study. The variable description can be found [here](http://biostat.mc.vanderbilt.edu/wiki/pub/Main/DataSets/rhc.html).


# Data Import

The data is an online resources, we will import data from the web directly  with `read_csv()` function. This dataset was originally used in Connors et al. JAMA 1996;276:889-897, and has been made publicly available.

```{r}
file <- "http://biostat.mc.vanderbilt.edu/wiki/pub/Main/DataSets/rhc.csv"
rhc <- read_csv(file)
```


# Data Wrangling

## Variable selection

There are totally `r ncol(rhc)` variables and `r nrow(rhc)` observations in the dataset. By reading the description of the data, we just want to select several variables here. When you try to reproduce this case study, you can try to choose others which you are interested in.  

```{r}
rhc_df <- 
  rhc %>% 
    select(age = age,
           sex = sex,
           race = race,
           education = edu,
           income = income,
           med_ins = ninsclas,
           disease = cat1,
           cancer = ca,
           weight = wtkilo1,
           temp = temp1,
           bp = meanbp1,
           resp = resp1,
           hrt = hrt1,
           pf = pafi1,
           pc = paco21,
           ph = ph1,
           death = dth30,
           time = t3d30,
           RHC = swang1)
#summary(rhc_df)
```

According to the [codebook](http://biostat.mc.vanderbilt.edu/wiki/pub/Main/DataSets/rhc.html),the description of variables we interested in is given below.

| variable names   |      meaning      |
|---------------------------------|---------------------------------|
| age                                  | Age                                                                                                                                                                 |
| sex                                  | Sex                                                                                                                                                                 |
| race                                 | Race                                                                                                                                                                |
| education                            | Years of education                                                                                                                                                  |
| income                               | Income                                                                                                                                                              |
| med_ins                              | Medical insurance                                                                                                                                                   |
| disease                              | Primary disease category                                                                                                                                            |
| cancer                               | Cancer                                                                                                                                                              |
| weight                               | Weight                                                                                                                                                              |
| temp                                 | Temperature                                                                                                                                                         |
| bp                                   | Mean blood pressure                                                                                                                                                 |
| resp                                 | Respiratory rate                                                                                                                                                    |
| rth                                  | Heart rate                                                                                                                                                          |
| pf                                   | PaO2/FIO2 ratio,ratio of arterial oxygen partial pressure to fractional inspired oxygen                                                                             |
| pc                                   | PaCo2 ratio,partial pressure of arterial carbon dioxide                                                                                                             |
| ph                                   | PH                                                                                                                                                                  |
| time                                 | Survival time of each patient in 30 days                                                                                                                            |
| death                                | Indicates whether the patient survived or dead in 30 days                                                                                                           |
| RHC                                  | Right heart catheterization |


# Exploratory data analysis

Our main topic is to investigate the influence of RHC, so let's devide the dataset into 'RHC' group and 'No RHC' group and try to find some difference between them. The demographics can help us understand the one to one relation between right heart catheterization and other symptoms.


```{r echo=T, results='hide'}
CreateTableOne(data = rhc_df, strata = 'RHC') %>%
  print() -> tblprint

tblprint[c(3,4, 9, 14, 21, 31, 43,45),4] <- 'Chi-sq'
```

```{r}
kable(tblprint , "html", 
      caption = "Stritified by Right Heart Catheterization", booktabs = T) %>%
  kable_styling('responsive') %>%
  add_indent(c(5:7, 10:13,15:20,22:30,32:34))
```

What do you see? Take a moment to reflect on what these differences suggest for the relationship of interest. The unadjusted outcomes indicate that patients managed with RHC were more likely to be white male, to have private insurance, to have under $11k income, to enter the study of ARF, MOSF or CHF. Patients with RHC were less likely to have cancer. 

## Data visualization

Data visuzlization is adjective considering it enables us to get a grasp on the difference between 'No RHC' and 'RHC' group. We would like to use `ggplot2` to create some plots.

```{r, fig.width=11, fig.height=5}
p1 <- rhc_df %>% 
        ggplot(aes(x = RHC, fill = sex)) + 
          geom_bar() +
           ggtitle('distribution of RHC')
p2 <- rhc_df %>% 
        ggplot(aes(x = RHC, fill = race)) + 
          geom_bar(position = "fill") + 
           ggtitle('distribution of RHC') + 
          ylab('proportion')

p3 <- rhc_df %>% 
        ggplot(aes(x = RHC, fill = med_ins)) + 
          geom_bar(position = "fill") + 
           ggtitle('distribution of RHC') + 
          ylab('proportion')

ggarrange(p1, p2, p3, ncol=3, nrow=1)
```
These plots further prove our undersatnding of the characteristics of patients: patients managed with RHC were more likely to be white male, to have private insurance. Here we just provide three examples, but try more variables you are interested in!

Besides three categorical variables, we also choose three continuous variables and visualize them.

```{r, fig.width=11, fig.height=5}
p4 <- rhc_df %>% 
        ggplot(aes(x = RHC, y = age, color = RHC)) + 
          geom_boxplot() + 
           ggtitle('distribution of age')
p5 <- rhc_df %>% 
        ggplot(aes(x = RHC, y = bp, color = RHC)) + 
          geom_boxplot() + 
           ggtitle('distribution of blood pressure')
p6 <- rhc_df %>% 
        ggplot(aes(x = RHC, y = pf, color = RHC)) + 
          geom_boxplot() + 
            ggtitle('distribution of PaO2/FiO2')

         
ggarrange(p4, p5,p6, ncol=3, nrow=1)
```

Age difference between two groups seems to be negligible while blood pressure and PaO2/FIO2 ratio vary largely. We see that patients who receive RHC tend to have lower blood pressure than patients who are not. Similiarly, patients who receive RHC tend to have lower PaO2/FIO2 ratio, which indicates that blood pressure and PaO2/FIO2 ratio are related to receiving RHC or not.


# Data analysis

## Survival analysis

[survival analysis](https://en.wikipedia.org/wiki/Survival_analysis) is a branch of statistics for analyzing the expected duration of time until one or more events happen, such as death in biological organisms and failure in mechanical systems. 

### Outcome and time variables

Changing the type of the data is also very important for survival analysis, and by checking the data, we need to deal with variables denoted as characters. In our data set, the status of having RHC or not is not numeric. A way to adjust is to force it into factor directly. However, this kind of factor format sometimes does not work in some of the packages in R. Therefore, we pushed the character into a numeric number and deducted it by 1 to get the numeric denotation that we want.

Here we use function `as.numeric()`.

```{r}
rhc_df$death <- as.numeric(as.factor(rhc_df$death)) -1
rhc_df$RHC <- as.numeric(as.factor(rhc_df$RHC)) - 1
```

### Kaplan Meier (non-parametric)

The [Kaplan Meier estimator](https://en.wikipedia.org/wiki/Kaplan–Meier_estimator) is a non-parametric method used to estimate the survival probability. It is often used to estimate the survival rate stratified by some treatment of interest.

```{r}
fit <- survfit(Surv(time, death) ~ RHC, data = rhc_df)
fit
```

The total number of the patients having right catheterization is `r sum(rhc_df$RHC == 1, na.rm = TRUE)`, and `r sum(rhc_df$RHC == 1, na.rm = TRUE)-fit$n.censor[58]` of them died in 30 days(38%). The total number of the patients not having right catheterization is `r sum(rhc_df$RHC == 0, na.rm = TRUE)`, and `r sum(rhc_df$RHC == 0, na.rm = TRUE) - fit$n.censor[29]` of them died in 30 days(30.6%).

```{r}
res.sum <- surv_summary(fit)
```

The description of arguments in `res_sum` is given below:

* time: the time points on the curve.
* n.risk: the number of subjects at risk at time t
* n.event: the number of events that occurred at time t.
* n.censor: the number of censored subjects, who exit the risk set, without an event, at time t.
* surv: estimate of survival probability.
* std.err: standard error of survival.
* upper: upper end of confidence interval
* lower: lower end of confidence interval
* strata: indicates stratification of curve estimation. If strata is not NULL, there are multiple curves in the result. The levels of strata (a factor) are the labels for the curves.


```{r}
autoplot(fit, conf.int = FALSE) +
  labs(title = 'Kaplan Meier Plot', 
       y = 'survival probability', color = 'RHC', fill = 'RHC') +
  theme_bw() +
  scale_color_manual(labels = c("No RHC", "RHC"), 
                     values = c("red", "blue"))
```

The Kaplan Meier plot shows us the survival rate stratified by having the RHC without any covariates adjustment.

The x-axis is the survival time, and the y-axis is the survival probability. It looks like a step function since the probability changes each day(the data only record the event daily).

Some of the description of the plot: at the beginning, all the patients survived. The survival probability of patients having the right catheterization is about `r fit$n.censor[58]/sum(rhc_df$RHC == 1, na.rm = TRUE)` and `r fit$n.censor[29]/sum(rhc_df$RHC == 0, na.rm = TRUE)` for patients not having the right catheterization. 


Function `rmst2()` in package [`survRM2`](https://cran.r-project.org/web/packages/survRM2/survRM2.pdf) performs two-sample comparisons using the restricted mean survival time (RMST) as a summary measure of the survival time distribution. Some basic arguments are shown below.


* `time`: The follow-up time for right censored data.
* `status`: The status indicator, 1=event, and 0=right censored.
* `arm`: The group indicator for comparison. 
* `tau`: A scaler value to specify the truncation time point for the RMST calculation. 
* `covariates`: This specifies covariates to be used for the adjusted analyses. When NULL, un-adjusted analyses are performed.

```{r}
rmst <- rmst2(rhc_df$time, rhc_df$death, 
              arm = rhc_df$RHC, tau = 30, covariates = NULL)

rmst$unadjusted.result %>%
  tidy() -> tbl.rmst

tbl.rmst %>%
  mutate(CI = paste('(',signif(lower..95,3), ',',
                    signif(upper..95,3),')')) -> tbl.rmst

tbl.rmst <- tbl.rmst[,c(1,2,6,5)]
colnames(tbl.rmst) <- c('Comparision', 'Estiamte', 
                        '95% CI', 'P-value')
tbl.rmst$`P-value`[tbl.rmst$`P-value` < 0.001] <- '<0.001'
tbl.rmst$Estiamte <- signif(tbl.rmst$Estiamte, 3)
kable(tbl.rmst[c(1,2),], "html", 
      caption = "Restricted mean survival time", booktabs = T) %>%  
  kable_styling('responsive')

```

The results show receiving RHC decrease the patients' restricted mean survival time by `r abs(tbl.rmst[1,2])` days. It seems that RHC is causing patients to live shorter. However, it's the result without any covariate adjustment. What if we want to adjust the model by the variables that we are interested in?


## Propensity socre matching

As we mentioned above, RHC is beneficial is the popular belief, which makes it harder to build a RCT. [Revelant paper]() explained this phenomenon like this: In ovservational studies, the treatment selection has connection with patients characteristics but also has link with the outcomes. For example, patients with lower blood pressure are more likely to get RHC, and they are also more likely to die. The effect of such treatment selection bias has been called "confounding by indication". To adjust for treatment selection bias, the variables that independently affect the decision to use or withhold the treatment must be identified and measured, that's why we introduce [propensity score matching (PSM)](https://en.wikipedia.org/wiki/Propensity_score_matching) here. 

In the statistical analysis of observational data, PSM is a statistical matching technique that attempts to estimate the effect of a treatment, policy, or other intervention by accounting for the covariates that predict receiving the treatment. PSM attempts to reduce the bias due to confounding variables that could be found in an estimate of the treatment effect obtained from simply comparing outcomes among units that received the treatment versus those that did not. 

The general procedures of PSM we would like to use include:


* Run logistic regression:
    + Dependent variable: Y = 1, if with RHC; Y = 0, otherwise.
    + Choose appropriate condounders and apply multivariate logistic regression.
    + Obtain propensity score, which is the predicted probability(p). Higher score indicates a higher probability of receiving the treatment.

* One-to-one matching on propensity score:
    + Randomly select one patient with RHC.
    + Match this patient who has the cloest propensity score in all patients with RHC.
    + Continue this matching untill all possible pairs were identified.
  
### Run logistic regression

```{r}
psm_glm <- glm(RHC ~ .-RHC-time-death, 
               family = binomial(link = "logit"), 
               data = rhc_df)
```

Using this model, we can now calculate the propensity score for each patient. It is simply the patient’s predicted probability of receiving RHC, given the estimates from the logit model. Then, we calculated this propensity score with the help of `predict()` and create a dataframe that has the propensity score as well as the patient’s actual treatment status.

```{r}
glm_df <- data.frame( p_rhc <-  predict(psm_glm, type = "response"),
                     # Predicted probability of being assigned to RHC
                      p_norhc <-  1 - p_rhc,
                     # Predicted probability of being assigned to no RHC
                      RHC <-  psm_glm$model$RHC)
```

After estimating the propensity score, histograms of the estimated propensity scores by treatment status is 

```{r}
glm_df %>%
  mutate(RHC = ifelse(RHC == 1, "RHC", "No RHC")) %>%
  ggplot(aes(x = p_rhc)) +
  geom_histogram(color = "white") +
  facet_wrap(~RHC) +
  xlab("Probability of receiving RHC") +
  theme_bw()
```

It is obvious the distribution of propensity score is not balanced, that's why we will move to the next step: one-to-one matching.


### One-to-one matching on propensity score

`matchit()` is the main command of the package [`MatchIt`](https://cran.r-project.org/web/packages/MatchIt/MatchIt.pdf), which enables parametric models for causal inference to work better by selecting well-matched subsets of the original treated and control groups.

The arguments provided by `matchit()` are given below:
* `formula`: Specifies the logistic regression formula you would like to use. Just equals to `psm_glm` we performed in last section.

* `data`: Data frame (or database table name) containing the variables for analysis in the formula arguments.

* `method`: Specifies the matching method. Default is "nearst(nearst neightbour matching)".

* `caliper`:Nearest neighbor matching has a further restriction that the absolute difference in the propensity scores of matched subjects must be below some prespecified threshold (the caliper distance). [Cochran and Rubin (1973)](https://www.ncbi.nlm.nih.gov/pmc/articles/PMC3144483/#s5title) suggested using a caliper size of one-fifth of a standard deviation of the sample estimated propensity scores.

* `ratio`: Indicates one-to-one matching — every treatment case will be matched with one control case. You can increase the number of control cases matched to each treatment case by increasing this number; usually this number is between 1 and 5.

```{r}
epsilon <- 0.2*sd(log(p_rhc/(1-p_rhc)))

psm_mod <- matchit(RHC ~ age + sex + race + education +
           income + med_ins + disease + cancer +
           weight + temp + bp + resp + hrt + pf +
           pc + ph, data = rhc_df, method = "nearest", 
           caliper  = epsilon, ratio = 1)

rhc_psm_df <- match.data(psm_mod)

#head(rhc_psm_df)
```

Using `match.data()`, we can get the final dataset, `rhc_psm_df`. Note that the final dataset is smaller than the original: it contains `r dim(rhc_psm_df)[1]` observations, meaning that `r 0.5*dim(rhc_psm_df)[1]` pairs of treated and control observations were matched. It also contains a variable called distance, which is the propensity score. Now 

```{r}
rhc_psm_df %>%
  mutate(RHC = ifelse(RHC == 1, "RHC", "No RHC")) %>%
  ggplot(aes(x = distance)) +
  geom_histogram(color = "white") +
  facet_wrap(~RHC) +
  xlab("Probability of receiving RHC") +
  theme_bw()
```
Now the distibution of propensity score are much more blanced! So the matching is done well. In addition to ploting by yourself, there is an another way to inplement the result.
```{r}
plot(psm_mod,type = "hist" )
```

Just putting the model name in `plot()` can offer you a nice plot, showing the overall comparison. It shows the histograms of distribution of propensity score before and after matching. The histograms before matching on the left differ to a great degree. The histograms after matching on the right are very similar however.





















# Proportional Hazard Model (Cox model)

In logistic regression, we know that whether an event is going to happen or not, and you could see survival analysis as an updated version of logistic regression where you could see when that even would happen.

Cox model, also known as proportional hazards models are a class of parametric survival models in statistics. It includes variables like the time that passes, the event occurs and other covariates that used to adjust the association of survival rate and time.

A fundamental assumption of the cox model is that the model assumes the hazard is constant with the time passing by.

### 1. Right censoring

We would only introduce right censoring in our case study, for the right censoring, we know that the patients are even-free up until the censoring time.

### 2. How do we record survival data

+ T = time to death

+ C = censoring time

However, we can only observe the $Y = min(C, T)$

it means that whether the patients dead or they drop the experiment


### 3. Survival Function

$$S(t) = P(T>t) = 1 - F(t)$$


To simplify, the survival rate equal to the probability of surviving at time t or one minus the probability of dying at time t



### 4. Hazard Function

$$H(t) = P(T = t|T \ge t)$$

It means that 

$$H(t) = \frac{number~ of~ individuals~ experiencing~ an~ event~ in~ interval~ beginning~ at~ t}{an~ event~ in~ interval~ beginning~ at~ time t \times (interval~ width)}$$

$$H(t) = \frac{f(t)}{S(t-1)}$$


wehre $f(t) = p(t=T)$


### 5. Proporites

+ non-increasing

+ survival rate at time 0 equal to 1

+ survival probability at time infinity equal to 0

+ the hazard function assumes proportional hazard meaning that the hazard is constant


We esitmate the hazard by the function:

$$H(t) = H_0(t) e^{\beta X}$$

where $\beta$ is the coefficients matrix and the X is the covariates matrix.





#```{r}
#fit1 <- coxph(Surv(t3d30,death) ~ . + .^2 ,data = rhc_df)
#
#```


We fit the model with all the variables and their pairwise interactions. Since we have too many variables, we won't interpret each of them. Just notice that if the coefficient is larger than 0, the variable will increase the survival probability and vice versa.


### 6. Adjusted Survival Plot

We could estimate the new survival plot by inputting the main predictor RHC, we first code all RHC as 0, predict the survival rate and input all RHC as 1, and predict the survival rate again.



#```{r}
#rhc0 <- RHC <- rhc_df
#rhc0$RHC <- 0
#RHC$RHC <- 1
#```



After extracting the survival rate, we can see that the effect of Right Heart Catheterization changed. The survival rate of the patients having the RHC is actually higher than those who don't have RHC. The red line is now above the blue line.




#```{r}
#time1 <- survfit(fit1, newdata = rhc0)$surv
#time2 <- survfit(fit1, newdata = RHC)$surv
#
#
#dat.time <- data.frame(time1 = rowMeans(time1), time2 = rowMeans(time2))
#ggplot(dat.time) +
#  geom_step(aes(x =1:length(dat.time$time1) ,y = time1, col = 'red')) +
#  geom_step(aes(x =1:length(dat.time$time2) ,y = time2, col = 'blue')) +
#  theme_survminer() +
#  theme_minimal() + labs(colour="Strata", x = "survival time", y = "probability", colour = 'RHC',  title = #'Survival Plot') +
#  scale_color_manual(labels = c("Yes RHC", "No RHC"), values = c("red", "blue"))
#
#  
#
#
#```




#```{r}
#meantime2 <- signif(mean(dat.time$time2) * 30 ,3)
#uptime2 <- signif(quantile(dat.time$time2, 0.975) ,3)
#lowtime2 <- signif(quantile(dat.time$time2, 0.025), 3)
#
#meantime1 <- signif(mean(dat.time$time1) * 30 ,3)
#uptime1 <- signif(quantile(dat.time$time1, 0.975), 3)
#lowtime1 <- signif(quantile(dat.time$time1, 0.025), 3)
#
#meantime2 - meantime1
#
#tbl.rmst$Estiamte <- c(meantime2 - meantime1, signif(meantime2 / meantime1,3), NA)
#tbl.rmst$`95% CI` <- c( paste('(', signif(lowtime2 - lowtime1,3), ',', (uptime2 - uptime1),')'), #paste('(', signif(lowtime2 / lowtime1,3), ',', signif(uptime2 / uptime1,3),')'), NA)
#
#
#kable(tbl.rmst[c(1,2),c(1,2,3)], "html", caption = "Restricted mean survival time", booktabs = T) %>%  #kable_styling('responsive')
#```


After adjusting the covariates that we already have had, having RHC decreased the mean survival time of the patients by 0.9 days. Comparing to the result with no adjustment, the decrease of the days decreased 0.6 days, Which means the result after adjusting all covariates show that RHC is less harmful than without modification.




# Reference



Lin DY, Psaty BM, Kronmal RA (1998): Assessing the sensitivity of regression results to unmeasured confounders in observational studies. Biometrics 54:948-963 for useful methods for sensitivity analysis, one of which was applied to the RHC results.


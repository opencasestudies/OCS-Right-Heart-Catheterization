---
title: "Case-study Right heart catheterization"
author: "Kexin Wang, M.S."
output:
  html_document:
    md_extensions: -startnum
    toc: yes
    toc_float:
      collapsed: yes
      smooth_scroll: no
  pdf_document:
    toc: yes
---


\newpage


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
knitr::opts_chunk$set(message = F)
knitr::opts_chunk$set(warning = F)

#library(tableone)
library(tidyverse)
library(survival)
library(survminer)
library(GGally)
library(survRM2)
library(knitr)
#library(kableExtra)
#library(randomForestSRC)
library(ggRandomForests)
library(pROC)
#library(grpreg)
#library(pec)
library(ggfortify)
library(broom)
library(finalfit)
```


# Motivation

[Right heart catheterization(RHC)](https://www.hopkinsmedicine.org/healthlibrary/test_procedures/cardiovascular/right_heart_catheterization_135,40), also known as pulmonary artery catheterization, is an invasive test that mainly checks the working state of the heart by guiding a pulmonary artery (PA) catheter (a small and hollow tube) through the pulmonary artery and into the right chambers of the heart. 

The motivation of the analysis is to reveal the association between time to death in 30 days and right heart catheterization (RHC). The main predictor of the model is right heart catheterization, we also adjust the model with all the other variables in the dataset. We want to know whether right heart catheterization actually improves the patients' survival rate in 30 days adjusted by other baseline variables.


Even though receiving RHC had decreased survival time in general, the unmeasured confounders can partly explain the results.


The libraries used in this study are listed in the following table, 
along with their purpose in this particular case study:

|Library|Purpose|
|---|--------------------------------------------------------------------------------------------------------------|


In order to run this code please ensure you have these packages installed. 

The learning objectives for this case study include:
  * survival analysis
  

# What is the data?

[Right heart catheterization](http://biostat.mc.vanderbilt.edu/wiki/pub/Main/DataSets/rhc.csv): The dataset pertains to day 1 of hospitalization, i.e., the treatment variable `swang1` is whether or not a patient received an RHC (also called the Swan-Ganz catheter) on the first day in which the patient qualified for the study. The variable description can be found [here](http://biostat.mc.vanderbilt.edu/wiki/pub/Main/DataSets/rhc.html). We just show part of them below.

| variable names   |      meaning      |
|---------------------------------|---------------------------------|
| Age                                  | Age                                                                                                                                                                 |
| Sex                                  | Sex                                                                                                                                                                 |
| Race                                 | Race                                                                                                                                                                |
| Edu                                  | Years of education                                                                                                                                                  |
| Income                               | Income                                                                                                                                                              |
| Ninsclas                             | Medical insurance                                                                                                                                                   |
| Cat1                                 | Primary disease category                                                                                                                                            |
| Cat2                                 | Secondary disease category                                                                                                                                          |
|                                      |                                                                                                                
| Ca                                   | Cancer                                                                                                                                                              |
| Surv2md1                             | Support model estimate of the prob. of surviving 2 months                                                                                                           |
| Aps1                                 | APACHE score                                                                                                                                                        |
| Scoma1                               | Glasgow Coma Score                                                                                                                                                  |
| Wtkilo1                              | Weight                                                                                                                                                              |
| Temp1                                | Temperature                                                                                                                                                         |
| Meanbp1                              | Mean blood pressure                                                                                                                                                 |
| Resp1                                | Respiratory rate                                                                                                                                                    |
| Hrt1                                 | Heart rate                                                                                                                                                          |
|                                      |                                                                                                                                                                     |
| Swang1                               | Right Heart Catheterization (RHC)                                                                                                                                   |                          
| Ptid                                 | Patient ID                                   |

# Data Import

If the data is an online resources, it would be updated by its website sometime. Instead of downloading and saving that file as `.csv` every time, importing data from the web directly is more reasonable. We can use the `read.csv()` function to import this `.csv` file from internet. The argument for `read.csv()` function, will be the URL of the data.

```{r}
file <- "http://biostat.mc.vanderbilt.edu/wiki/pub/Main/DataSets/rhc.csv"
rhc <- read.csv(file, header = TRUE)
```


# Data Wrangling

## Data cleaning

By reading the description of the data, we need to exclude several variables in the dataset. The variables including all the enrollment time, discharge time and so on but we just care about death in 30 days. 

The variables that we would like to excluded.

| Vairbale Name | Meaning |
|---------------|---------------------------------------------|
| X       | Serial number |
| ptid    | Patient ID  |
| cat2    | Secondary disease category  |
| sadmdte | Study Admission Date        |
| dschdte | Hospital Discharge Date     |
| dthdte  | Date of Death  |
| lstctdte| Date of Last Contact        |
| death   | Death at any time up to 180 Days |
| surv2md1| Support model estimate of the prob. of surviving 2 months |

```{r}
var.vector <- c(
"X",
"cat2",
"sadmdte",
"dschdte",
"dthdte",
"lstctdte",
"death",
"surv2md1",
"ptid"
)
var.which <- NULL
for (i in var.vector) {
  var.which[i] <- which(names(rhc) == i)
}
```

And the variables with the percentage of the missing value larger than 20% are also excluded (We choose 20% as an arbitrary number since we do not want to lose too much information from the whole data set).

```{r}
var.which2 <- NULL
for (i in names(rhc)) {
  if( sum(is.na(rhc[,i]))/nrow(rhc) > 0.2 ){
    var.which2[i] <- which(names(rhc) == i)
  }
}
```
```{r}
rhc_df <- rhc[,-c(var.which, var.which2)]
```

`sum(is.na(rhc[,i]))` is used to calculate the total missing value for variable `i`. Then divide it with `nrow(rhc)` and we will receive the proportion of missing value for this variable.

After this step, we keep `r nrow(rhc_df)` rows and `r ncol(rhc_df)` columns.

## Check the type of the data

We can print the summary and the type of data first to take a look at the dataset. The summary of the data will give us some characteristics of the data such as mean, median quantiles, and frequency.

The type of data can show us whether the variable is stored as factor, string, int or number.

```{r}
rhc_df %>% 
  group_by(swang1) %>%
  summarise_if(is.numeric, funs(n(),mean))
```
```{r}
rhc_df %>% 
  select(swang1,sex) %>%
  group_by(swang1,sex) %>%
  summarise(n())
```
```{r}
explanatory = c ('sex', 'age', 'race',
'ca', 'dth30', 'temp1', 'hrt1','meanbp1')
rhc_df %>%
  summary_factorlist('swang1', explanatory)
```

## Outcome and time variables

Changing the type of the data is also very important for survival analysis, and by checking the data, we need to deal with variables denoted as characters. In our data set, the status of having RHC or not is not numeric. A way to adjust is to force it into factor directly. However, this kind of factor format sometimes does not work in some of the packages in R. Therefore, we pushed the character into a numeric number and deducted it by 1 to get the numeric denotation that we want.


We also used an easy way to change all the variable type to the right one by using a loop. The main idea is that after observing the summary of the data, we can approximately say that the variables with mean larger than five should be continuous variables, the others should be binary or other factors with more levels instead.


```{r}
for (i in names(rhc_df)) {
  if(is.numeric(rhc_df[,i])){
    if(mean(rhc_df[,i], na.rm = T) < 5){
      rhc_df[,i] <- as.factor((rhc_df[,i]))
    }else{
      rhc_df[,i] <- ((rhc_df[,i]))
    }
  }
}

rhc_df$dth30 <- as.numeric(rhc_df$dth30) - 1
rhc_df$swang1 <- as.numeric(rhc_df$swang1) - 1
rhc_df$alb1 <- as.numeric(as.character(rhc_df$alb1))
rhc_df$bili1 <- as.numeric(as.character(rhc_df$bili1))
rhc_df$crea1 <-  as.numeric(as.character(rhc_df$crea1))
rhc_df$pot1 <- as.numeric(as.character(rhc_df$pot1))
```


# Exploratory data analysis





# Data analysis

## Propensity socre

In the statistical analysis of observational data, [propensity score matching (PSM)](https://en.wikipedia.org/wiki/Propensity_score_matching) is a statistical matching technique that attempts to estimate the effect of a treatment, policy, or other intervention by accounting for the covariates that predict receiving the treatment. PSM attempts to reduce the bias due to confounding variables that could be found in an estimate of the treatment effect obtained from simply comparing outcomes among units that received the treatment versus those that did not. 

## Survival analysis


### Kaplan Meier (non-parametric)


The Kaplan Meier estimator is a non-parametric method used to estimate the survival probability. It is often used to estimate the survival rate stratified by some treatment of interest.


```{r}
fit <- survfit(Surv(t3d30, dth30) ~ swang1, data = rhc_df)
res.sum <- surv_summary(fit)
head(res.sum[,1:6])
```

* time: the time points on the curve.
* n.risk: the number of subjects at risk at time t
* n.event: the number of events that occurred at time t.
* n.censor: the number of censored subjects, who exit the risk set, without an event, at time t.
* surv: estimate of survival probability.
* std.err: standard error of survival.
* upper: upper end of confidence interval
* lower: lower end of confidence interval
* strata: indicates stratification of curve estimation. If strata is not NULL, there are multiple curves in the result. The levels of strata (a factor) are the labels for the curves.



The t3d30 is the survival time of each patient and dth30 is the dummy variable that indicates whether the patient survived or dead in 30 days.

The total number of the patients having right catheterization is 2184, and 830 of them died in 30 days(38%). The total number of the patients not having right catheterization is 3551, and 1088 of them died in 30 days(30.6%).

```{r}

autoplot(fit, conf.int = FALSE) +
  labs(title = 'Kaplan Meier Plot', 
       y = 'survival probability', color = 'RHC', fill = 'RHC') +
  theme_bw() +
  scale_color_manual(labels = c("No RHC", "Yes RHC"), values = c("red", "blue"))

```

The Kaplan Meier plot shows us the survival rate stratified by having the right heart catheterization without any covariates adjustment.

The x-axis is the survival time, and the y-axis is the survival probability. It looks like a step function since the probability changes each day(the data only record the event daily).

Some of the description of the plot: at the beginning, all the patients survived. The survival probability of patients having the right catheterization is about 62.00% and 69.36% for patients not having the right catheterization. 

```{r}
psurv <- ggsurvplot(fit,
       pval = TRUE, conf.int = TRUE,
       linetype = "swang1", # Change line type by groups
       ggtheme = theme_bw(), # Change ggplot2 theme
       palette = c("#E7B800", "#2E9FDF"),
      fun = "event"
       )
psurv
```


#```{r}
#rmst <- rmst2(rhc_df$t3d30, rhc_df$dth30, arm = rhc_df$swang1, tau = 30, covariates = NULL)
#
#rmst$unadjusted.result %>%
#  tidy() -> tbl.rmst
#
#tbl.rmst %>%
#  mutate(CI = paste('(',signif(lower..95,3), ',',signif(upper..95,3),')')) -> tbl.rmst
#
#tbl.rmst <- tbl.rmst[,c(1,2,6,5)]
#colnames(tbl.rmst) <- c('Comparision', 'Estiamte', '95% CI', 'P-value')
#tbl.rmst$`P-value`[tbl.rmst$`P-value` < 0.001] <- '<0.001'
#tbl.rmst$Estiamte <- signif(tbl.rmst$Estiamte, 3)
#kable(tbl.rmst[c(1,2),], "html", caption = "Restricted mean survival time", booktabs = T) %>%  #kable_styling('responsive')
#  
#
#```



The results show that having RHC decrease the patients' restricted mean survival time by 1.5 days. It seems that RHC is causing patients to live less long. However, it's the result without any covariate adjustment. What if we want to adjust the model by the variables that we are interested in?



# Proportional Hazard Model (Cox model)

In logistic regression, we know that whether an event is going to happen or not, and you could see survival analysis as an updated version of logistic regression where you could see when that even would happen.

Cox model, also known as proportional hazards models are a class of parametric survival models in statistics. It includes variables like the time that passes, the event occurs and other covariates that used to adjust the association of survival rate and time.

A fundamental assumption of the cox model is that the model assumes the hazard is constant with the time passing by.

### 1. Right censoring

We would only introduce right censoring in our case study, for the right censoring, we know that the patients are even-free up until the censoring time.

### 2. How do we record survival data

+ T = time to death

+ C = censoring time

However, we can only observe the $Y = min(C, T)$

it means that whether the patients dead or they drop the experiment


### 3. Survival Function

$$S(t) = P(T>t) = 1 - F(t)$$


To simplify, the survival rate equal to the probability of surviving at time t or one minus the probability of dying at time t



### 4. Hazard Function

$$H(t) = P(T = t|T \ge t)$$

It means that 

$$H(t) = \frac{number~ of~ individuals~ experiencing~ an~ event~ in~ interval~ beginning~ at~ t}{an~ event~ in~ interval~ beginning~ at~ time t \times (interval~ width)}$$

$$H(t) = \frac{f(t)}{S(t-1)}$$


wehre $f(t) = p(t=T)$


### 5. Proporites

+ non-increasing

+ survival rate at time 0 equal to 1

+ survival probability at time infinity equal to 0

+ the hazard function assumes proportional hazard meaning that the hazard is constant


We esitmate the hazard by the function:

$$H(t) = H_0(t) e^{\beta X}$$

where $\beta$ is the coefficients matrix and the X is the covariates matrix.





#```{r}
#fit1 <- coxph(Surv(t3d30,dth30) ~ . + .^2 ,data = rhc_df)
#
#```


We fit the model with all the variables and their pairwise interactions. Since we have too many variables, we won't interpret each of them. Just notice that if the coefficient is larger than 0, the variable will increase the survival probability and vice versa.


### 6. Adjusted Survival Plot

We could estimate the new survival plot by inputting the main predictor RHC, we first code all RHC as 0, predict the survival rate and input all RHC as 1, and predict the survival rate again.



#```{r}
#rhc0 <- rhc1 <- rhc_df
#rhc0$swang1 <- 0
#rhc1$swang1 <- 1
#```



After extracting the survival rate, we can see that the effect of Right Heart Catheterization changed. The survival rate of the patients having the RHC is actually higher than those who don't have RHC. The red line is now above the blue line.




#```{r}
#time1 <- survfit(fit1, newdata = rhc0)$surv
#time2 <- survfit(fit1, newdata = rhc1)$surv
#
#
#dat.time <- data.frame(time1 = rowMeans(time1), time2 = rowMeans(time2))
#ggplot(dat.time) +
#  geom_step(aes(x =1:length(dat.time$time1) ,y = time1, col = 'red')) +
#  geom_step(aes(x =1:length(dat.time$time2) ,y = time2, col = 'blue')) +
#  theme_survminer() +
#  theme_minimal() + labs(colour="Strata", x = "survival time", y = "probability", colour = 'RHC',  title = #'Survival Plot') +
#  scale_color_manual(labels = c("Yes RHC", "No RHC"), values = c("red", "blue"))
#
#  
#
#
#```




#```{r}
#meantime2 <- signif(mean(dat.time$time2) * 30 ,3)
#uptime2 <- signif(quantile(dat.time$time2, 0.975) ,3)
#lowtime2 <- signif(quantile(dat.time$time2, 0.025), 3)
#
#meantime1 <- signif(mean(dat.time$time1) * 30 ,3)
#uptime1 <- signif(quantile(dat.time$time1, 0.975), 3)
#lowtime1 <- signif(quantile(dat.time$time1, 0.025), 3)
#
#meantime2 - meantime1
#
#tbl.rmst$Estiamte <- c(meantime2 - meantime1, signif(meantime2 / meantime1,3), NA)
#tbl.rmst$`95% CI` <- c( paste('(', signif(lowtime2 - lowtime1,3), ',', (uptime2 - uptime1),')'), #paste('(', signif(lowtime2 / lowtime1,3), ',', signif(uptime2 / uptime1,3),')'), NA)
#
#
#kable(tbl.rmst[c(1,2),c(1,2,3)], "html", caption = "Restricted mean survival time", booktabs = T) %>%  #kable_styling('responsive')
#```


After adjusting the covariates that we already have had, having RHC decreased the mean survival time of the patients by 0.9 days. Comparing to the result with no adjustment, the decrease of the days decreased 0.6 days, Which means the result after adjusting all covariates show that RHC is less harmful than without modification.




# Reference



Lin DY, Psaty BM, Kronmal RA (1998): Assessing the sensitivity of regression results to unmeasured confounders in observational studies. Biometrics 54:948-963 for useful methods for sensitivity analysis, one of which was applied to the RHC results.


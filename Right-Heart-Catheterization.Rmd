---
title: "Case-study Right heart catheterization"
author: "Hanchao Zhang, M.S."
output:
  pdf_document:
    toc: yes
  html_document:
    md_extensions: -startnum
    toc: yes
    toc_float:
      collapsed: yes
      smooth_scroll: no
---


\newpage


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(survival)
library(GGally)
library(survRM2)
library(knitr)
library(randomForestSRC)
library(ggRandomForests)
library(pROC)
library(grpreg)
library(pec)
```

## Motivation

Right heart catheterization (RHC), also known as pulmonary artery catheterization, is an invasive test that mainly checks the working state of the heart by guiding a pulmonary artery (PA) catheter (a small and hollow tube) through the pulmonary artery and into the right chambers of the heart. By this way, the catheter can measure the functions of the heart such as blood pressure, cardiac output, etc., including other measures in connection to heart problems such as diurnal respiratory instability according to one study by Kumagai, et al. (2018). In turn, these measurements are used to treat and manage heart conditions such as heart failure, congenital heart disease, cardiomyopathy, pulmonary hypertension, etc. Thus, many cardiologists and critical care physicians believe that the direct measurements of the cardiac functions by RHC is necessary to the management of treating critically ill patients and that such management will theoretically lead to better health outcomes according to Connors, et al. (1996). However, due to the severity of the cardiac conditions of the patients as well as the invasive procedure of RHC with no guarantee of any beneficial outcomes, data measuring the benefits of the RHC procedure cannot easily be collected in a randomized control trial (RCT). To make up for this, observational studies were used to evaluate the effectiveness of the RHC procedure. Although, these studies are

susceptible to treatment selection bias as physicians can make the decision to use or withhold RHC in the treatment of their patients.

The purpose of this study is to reproduce the statistical analysis of the objective of the research, The Effectiveness of Right Heart Catheterization in the Initial Care, using the data it collected from a large group of critically ill patients and in predefined patient subgroups in order to determine how valid is the association between the use of the right heart catheterization during the first 24 hours of an ICU stay with subsequent survival, length of stay, intensity of care, and cost of care.

You can find the description of the data from http://biostat.mc.vanderbilt.edu/wiki/pub/Main/DataSets/rhc.html


## Data preparation

By reading the description of the data, we need to exclude several variables in the data set. The variables including all the enrollment time, discharge time and so on, and the variable with percentage of missing value larger than 20%.

We choose 20% as an arbitary number since we do not want to loss too much information from the whole data set.


```{r}
rhc <- read.csv("http://biostat.mc.vanderbilt.edu/wiki/pub/Main/DataSets/rhc.csv")
rhc <- rhc[,-1]
var.vector <- c(
"cat2",
"sadmdte",
"dschdte",
"dthdte",
"lstctdte",
"death",
"surv2md1",
"ptid"
)
var.which <- NULL
for (i in var.vector) {
  var.which[i] <- which(names(rhc) == i)
}

var.which2 <- NULL
for (i in names(rhc)) {
  if( sum(is.na(rhc[,i]))/nrow(rhc) > 0.2 ){
    var.which2[i] <- which(names(rhc) == i)
  }
}

dat.rhc <- rhc[,-c(var.which, var.which2)]
```



```{r}
summary(dat.rhc)
str(dat.rhc)
```

Changing the type of the data is also very important for survival analysis



```{r}
for (i in names(dat.rhc)) {
  if(is.numeric(dat.rhc[,i])){
    if(mean(dat.rhc[,i], na.rm = T) < 5){
      dat.rhc[,i] <- as.factor((dat.rhc[,i]))
    }else{
      dat.rhc[,i] <- ((dat.rhc[,i]))
    }
  }
}
dat.rhc$dth30 <- as.numeric(dat.rhc$dth30) - 1
dat.rhc$swang1 <- as.numeric(dat.rhc$swang1) - 1
```




```{r}
summary(dat.rhc)
str(dat.rhc)
```

## Analysis

### Cox model and Survival Random Forest

After cleaning the data, we can fit the cox model and survival random forest with our data

```{r}
fit1 <- coxph(Surv(t3d30,dth30) ~ . ,data = dat.rhc)
fit2 <- rfsrc(Surv(t3d30,dth30) ~ ., data = dat.rhc, nsplit = 10, importance = TRUE, ntree = 100)

```


### Cross validation

We can definetly compute cross validation test error by our own code. However, for the survival analysis, the 'pec' package save us lots of effort to do the cross validation and also the function is faster.

```{r}


#fitpec1 <- pec(list("Cox" = fit1), formula = Surv(t3d30,dth30) ~ 1, data = dat.rhc, cens.model = 'cox', splitMethod = "cv3", keep.index = TRUE, keep.matrix = TRUE)


```



### Restricted Mean Survival time (Causual Inference)

Causal inference is the process of drawing a conclusion about a causal connection based on the conditions of the occurrence of an effect. The main difference between causal inference and inference of association is that the former analyzes the response of the effect variable when the cause is changed.[1][2] The science of why things occur is called etiology. Causal inference is an example of causal reasoning (https://en.wikipedia.org/wiki/Causal_inference)

We will use the idea of it to compute the difference of survival time between having RHC and not having RHC by both model

```{r}
rhc0 <- rhc1 <- dat.rhc
rhc0$swang1 <- 0
rhc1$swang1 <- 1
```


```{r}
time1 <- survfit(fit1, newdata = rhc0)$surv
time2 <- survfit(fit1, newdata = rhc1)$surv

rowMeans(time1) %>%
  plot(type = "l", col = "blue", main = 'RMST-Cox model', xlab = 'Days', ylab = 'Survival Rate')
rowMeans(time2) %>%
  lines(col = "red")
legend('topright', c('No RHC','RHC'), col = c('blue','red'), pch = 20)
```






```{r}
time3 <- predict(fit2, newdata = rhc0)$survival
time4 <- predict(fit2, newdata = rhc1)$survival


colMeans(time3) %>%
  plot(type = "l", col = "blue", main = 'RMST-Survival random forest', xlab = 'Days', ylab = 'Survival Rate')
colMeans(time4) %>%
  lines(col = "red")
legend('topright', c('No RHC','RHC'), col = c('blue','red'), pch = 20)
```













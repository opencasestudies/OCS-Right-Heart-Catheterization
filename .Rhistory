pc = paco21,
ph = ph1,
death = dth30,
time = t3d30,
RHC = swang1)
#summary(rhc_df)
p1 <- rhc_df %>%
ggplot(aes(x = RHC, fill = sex)) +
geom_bar() + ggtitle('distribution of RHC')
p2 <- rhc_df %>%
ggplot(aes(x = RHC, fill = race)) +
geom_bar(position = "fill") +
ggtitle('distribution of RHC') +
ylab('proportion')
p3 <- rhc_df %>%
ggplot(aes(x = RHC, fill = med_ins)) +
geom_bar(position = "fill") +
ggtitle('distribution of RHC') +
ylab('proportion')
ggarrange(p1, p2, p3, ncol=3, nrow=1)
p4 <- rhc_df %>%
ggplot(aes(x = RHC, y = age, color = RHC)) +
geom_boxplot() + ggtitle('distribution of age')
p5 <- rhc_df %>%
ggplot(aes(x = RHC, y = bp, color = RHC)) +
geom_boxplot() + ggtitle('distribution of blood pressure')
p6 <- rhc_df %>%
ggplot(aes(x = RHC, y = pf, color = RHC)) +
geom_boxplot() + ggtitle('distribution of PaO2/FiO2')
ggarrange(p4, p5,p6, ncol=3, nrow=1)
psm_glm <- glm(RHC ~ .-RHC, family = binomial(link = "logit"),
data = rhc_df)
rhc_df$death <- as.numeric(as.factor(rhc_df$death)) -1
rhc_df$RHC <- as.numeric(as.factor(rhc_df$RHC)) - 1
rhc_df$RHC
psm_glm <- glm(RHC ~ .-RHC, family = binomial(link = "logit"),
data = rhc_df)
psm_df <- data.frame( p_rhc = predict(psm_glm, type = "response"),
# Predicted probability of being assigned to RHC
p_norhc = 1 - p_rhc,
# Predicted probability of being assigned to no RHC
RHC = psm_glm$model$RHC)
psm_df <- data.frame( p_rhc <-  predict(psm_glm, type = "response"),
# Predicted probability of being assigned to RHC
p_norhc = 1 - p_rhc,
# Predicted probability of being assigned to no RHC
RHC = psm_glm$model$RHC)
psm_df %>%
mutate(RHC = ifelse(RHC == 1, "RHC", "No RHC")) %>%
ggplot(aes(x = p_rhc)) +
geom_histogram(color = "white") +
facet_wrap(~RHC) +
xlab("Probability of receiving RHC") +
theme_bw()
psm_mod <- matchit(RHC ~ age + sex + race + education +
income + med_ins + disease + cancer +
weight + temp + bp + resp + hrt + pf +
pc + ph, data = rhc_df)
rhc_match <- match.data(psm_mod)
rhc_match %>%
mutate(RHC = ifelse(RHC == 1, "RHC", "No RHC")) %>%
ggplot(aes(x = distance)) +
geom_histogram(color = "white") +
facet_wrap(~RHC) +
xlab("Probability of receiving RHC") +
theme_bw()
sum(rhc_match$RHC == 1, na.rm = TRUE)
sum(rhc_match$RHC == 0, na.rm = TRUE)
plot(rhc_match$distance)
rhc_match %>%
mutate(RHC = ifelse(RHC == 1, "RHC", "No RHC")) %>%
ggplot(aes(x = distance)) +
geom_point() +
facet_wrap(~RHC) +
xlab("Probability of receiving RHC") +
theme_bw()
psm_mod <- matchit(RHC ~ age + sex + race + education +
income + med_ins + disease + cancer +
weight + temp + bp + resp + hrt + pf +
pc + ph, data = rhc_df)
rhc_match <- match.data(psm_mod)
rhc_match %>%
mutate(RHC = ifelse(RHC == 1, "RHC", "No RHC")) %>%
ggplot(aes(x = RHC, y = distance,color = RHC))+
geom_point() +
facet_wrap(~RHC) +
xlab("Probability of receiving RHC") +
theme_bw()
rhc_match %>%
mutate(RHC = ifelse(RHC == 1, "RHC", "No RHC")) %>%
ggplot(aes(x = RHC, y = distance,color = RHC))+
geom_boxplot() +
facet_wrap(~RHC) +
xlab("Probability of receiving RHC") +
theme_bw()
psm_mod <- matchit(RHC ~ age + sex + race + education +
income + med_ins + disease + cancer +
weight + temp + bp + resp + hrt + pf +
pc + ph, data = rhc_df,method = "nearest", ratio = 1)
rhc_match <- match.data(psm_mod)
rhc_match %>%
mutate(RHC = ifelse(RHC == 1, "RHC", "No RHC")) %>%
ggplot(aes(x = RHC, y = distance,color = RHC))+
geom_boxplot() +
facet_wrap(~RHC) +
xlab("Probability of receiving RHC") +
theme_bw()
rhc_df$RHC
rhc_df <-
rhc %>%
select(age = age,
sex = sex,
race = race,
education = edu,
income = income,
med_ins = ninsclas,
disease = cat1,
cancer = ca,
weight = wtkilo1,
temp = temp1,
bp = meanbp1,
resp = resp1,
hrt = hrt1,
pf = pafi1,
pc = paco21,
ph = ph1,
death = dth30,
time = t3d30,
RHC = swang1)
#summary(rhc_df)
psm_mod <- matchit(RHC ~ age + sex + race + education +
income + med_ins + disease + cancer +
weight + temp + bp + resp + hrt + pf +
pc + ph, data = rhc_df,method = "nearest", ratio = 1)
rhc_df$RHC
rhc_df %>%
mutate(RHC = ifelse(RHC == "RHC", 1,0))
psm_mod <- matchit(RHC ~ age + sex + race + education +
income + med_ins + disease + cancer +
weight + temp + bp + resp + hrt + pf +
pc + ph, data = rhc_df,method = "nearest", ratio = 1)
rhc_df$RHC
as.factor(rhc_df$RHC)
as.numeric(as.factor(rhc_df$RHC))
rhc_df$death <- as.numeric(as.factor(rhc_df$death)) -1
rhc_df$RHC <- as.numeric(as.factor(rhc_df$RHC)) - 1
psm_glm <- glm(RHC ~ .-RHC-time-death, family = binomial(link = "logit"),
data = rhc_df)
psm_df <- data.frame( p_rhc <-  predict(psm_glm, type = "response"),
# Predicted probability of being assigned to RHC
p_norhc <-  1 - p_rhc,
# Predicted probability of being assigned to no RHC
RHC <-  psm_glm$model$RHC)
psm_df %>%
mutate(RHC = ifelse(RHC == 1, "RHC", "No RHC")) %>%
ggplot(aes(x = p_rhc)) +
geom_histogram(color = "white") +
facet_wrap(~RHC) +
xlab("Probability of receiving RHC") +
theme_bw()
psm_mod <- matchit(RHC ~ age + sex + race + education +
income + med_ins + disease + cancer +
weight + temp + bp + resp + hrt + pf +
pc + ph, data = rhc_df,method = "nearest", ratio = 1)
rhc_match <- match.data(psm_mod)
rhc_match %>%
mutate(RHC = ifelse(RHC == 1, "RHC", "No RHC")) %>%
ggplot(aes(x = RHC, y = distance,color = RHC))+
geom_boxplot() +
facet_wrap(~RHC) +
xlab("Probability of receiving RHC") +
theme_bw()
histbackback(split(rhc_match$distance, rhc_match$RHC))
plot(psm_mod, type = "jitter")
rhc_match %>%
mutate(RHC = ifelse(RHC == 1, "RHC", "No RHC")) %>%
ggplot(aes(x = distance)) +
geom_histogram(color = "white") +
facet_wrap(~RHC) +
xlab("Probability of receiving RHC") +
theme_bw()
psm_mod <- matchit(RHC ~ age + sex + race + education +
income + med_ins + disease + cancer +
weight + temp + bp + resp + hrt + pf +
pc + ph, data = rhc_df,method = "exact", ratio = 1)
psm_mod <- matchit(RHC ~ age + sex + race + education +
income + med_ins + disease + cancer +
weight + temp + bp + resp + hrt + pf +
pc + ph, data = rhc_df,method = "nearest", ratio = 1)
rhc_match <- match.data(psm_mod)
psm_mod <- matchit(RHC ~ age + sex + race + education +
income + med_ins + disease + cancer +
weight + temp + bp + resp + hrt + pf +
pc + ph, data = rhc_df,method = "nearest",
caliper  = 0.2, ratio = 1)
rhc_match <- match.data(psm_mod)
rhc_match %>%
mutate(RHC = ifelse(RHC == 1, "RHC", "No RHC")) %>%
ggplot(aes(x = distance)) +
geom_histogram(color = "white") +
facet_wrap(~RHC) +
xlab("Probability of receiving RHC") +
theme_bw()
psm_mod <- matchit(RHC ~ age + sex + race + education +
income + med_ins + disease + cancer +
weight + temp + bp + resp + hrt + pf +
pc + ph, data = rhc_df,method = "nearest",
caliper  = 0.03, ratio = 1)
rhc_match <- match.data(psm_mod)
0.2*sd(logit(p_rhc))
0.2*sd(log(p_rhc/(1-p_rhc)))
psm_mod <- matchit(RHC ~ age + sex + race + education +
income + med_ins + disease + cancer +
weight + temp + bp + resp + hrt + pf +
pc + ph, data = rhc_df,method = "nearest",
caliper  = 0.25, ratio = 1ï¼Œ
psm_mod <- matchit(RHC ~ age + sex + race + education +
income + med_ins + disease + cancer +
weight + temp + bp + resp + hrt + pf +
pc + ph, data = rhc_df,method = "nearest",
caliper  = 0.25, ratio = 1,
distance = "mahalanobis")
psm_mod <- matchit(RHC ~ age + sex + race + education +
income + med_ins + disease + cancer +
weight + temp + bp + resp + hrt + pf +
pc + ph, data = rhc_df,method = "nearest",
caliper  = 0.25, ratio = 1)
rhc_match <- match.data(psm_mod)
epsilon <- 0.25*sd(log(p_rhc/(1-p_rhc)))
psm_mod <- matchit(RHC ~ age + sex + race + education +
income + med_ins + disease + cancer +
weight + temp + bp + resp + hrt + pf +
pc + ph, data = rhc_df,method = "nearest",
caliper  = epsilon, ratio = 1)
rhc_match <- match.data(psm_mod)
epsilon <- 0.2*sd(log(p_rhc/(1-p_rhc)))
psm_mod <- matchit(RHC ~ age + sex + race + education +
income + med_ins + disease + cancer +
weight + temp + bp + resp + hrt + pf +
pc + ph, data = rhc_df,method = "nearest",
caliper  = epsilon, ratio = 1)
rhc_match <- match.data(psm_mod)
psm_mod <- matchit(RHC ~ age + sex + race + education +
income + med_ins + disease + cancer +
weight + temp + bp + resp + hrt + pf +
pc + ph, data = rhc_df,method = "nearest",
caliper  = 0.03, ratio = 1)
rhc_match <- match.data(psm_mod)
rhc_match %>%
mutate(RHC = ifelse(RHC == 1, "RHC", "No RHC")) %>%
ggplot(aes(x = distance)) +
geom_histogram(color = "white") +
facet_wrap(~RHC) +
xlab("Probability of receiving RHC") +
theme_bw()
dim(rhc_match)[1]
0.5*dim(rhc_match)[1]
dim(rhc_match)[1]
epsilon
epsilon <- 0.2*sd(log(p_rhc))
epsilon
epsilon <- 0.2*sd(log(p_rhc))
psm_mod <- matchit(RHC ~ age + sex + race + education +
income + med_ins + disease + cancer +
weight + temp + bp + resp + hrt + pf +
pc + ph, data = rhc_df, method = "nearest",
caliper  = epsilon, ratio = 1)
rhc_match <- match.data(psm_mod)
epsilon <- 0.2*sd(log(p_rhc/(1-p_rhc)))
psm_mod <- matchit(RHC ~ age + sex + race + education +
income + med_ins + disease + cancer +
weight + temp + bp + resp + hrt + pf +
pc + ph, data = rhc_df, method = "nearest",
caliper  = epsilon, ratio = 1)
rhc_psm_df <- match.data(psm_mod)
#head(rhc_psm_df)
p_rhc
distance
rhc_psm_df$distance
glm_df %>%
mutate(RHC = ifelse(RHC == 1, "RHC", "No RHC")) %>%
ggplot(aes(x = p_rhc)) +
geom_histogram(color = "white") +
facet_wrap(~RHC) +
xlab("Probability of receiving RHC") +
theme_bw()
psm_glm <- glm(RHC ~ .-RHC-time-death, family = binomial(link = "logit"),
data = rhc_df)
glm_df <- data.frame( p_rhc <-  predict(psm_glm, type = "response"),
# Predicted probability of being assigned to RHC
p_norhc <-  1 - p_rhc,
# Predicted probability of being assigned to no RHC
RHC <-  psm_glm$model$RHC)
glm_df %>%
mutate(RHC = ifelse(RHC == 1, "RHC", "No RHC")) %>%
ggplot(aes(x = p_rhc)) +
geom_histogram(color = "white") +
facet_wrap(~RHC) +
xlab("Probability of receiving RHC") +
theme_bw()
plot(p_rhc, rhc_psm_df$distance)
boxplot(p_rhc)
boxplot(rhc_psm_df$distance)
plot(psm_mod,type = "hist" )
glm_df %>%
mutate(RHC = ifelse(RHC == 1, "RHC", "No RHC")) %>%
ggplot(aes(x = p_rhc)) +
geom_histogram(color = "red") +
facet_wrap(~RHC) +
xlab("Probability of receiving RHC") +
theme_bw()
glm_df %>%
mutate(RHC = ifelse(RHC == 1, "RHC", "No RHC")) %>%
ggplot(aes(x = p_rhc)) +
geom_histogram(color = "white") +
facet_wrap(~RHC) +
xlab("Probability of receiving RHC") +
theme_bw()
glm_df %>%
mutate(RHC = ifelse(RHC == 1, "RHC", "No RHC")) %>%
ggplot(aes(x = p_rhc, color = factor(RHC))) +
geom_histogram(color = "white") +
facet_wrap(~RHC) +
xlab("Probability of receiving RHC") +
theme_bw()
glm_df %>%
mutate(RHC = ifelse(RHC == 1, "RHC", "No RHC")) %>%
ggplot(aes(x = p_rhc)) +
geom_histogram(color = "white", color = factor(RHC)) +
facet_wrap(~RHC) +
xlab("Probability of receiving RHC") +
theme_bw()
glm_df %>%
mutate(RHC = ifelse(RHC == 1, "RHC", "No RHC")) %>%
ggplot(aes(x = p_rhc),color = factor(RHC)) +
geom_histogram(color = "white") +
facet_wrap(~RHC) +
xlab("Probability of receiving RHC") +
theme_bw()
glm_df %>%
mutate(RHC = ifelse(RHC == 1, "RHC", "No RHC")) %>%
ggplot(aes(x = p_rhc)) +
geom_histogram(color = "white") +
#facet_wrap(~RHC) +
xlab("Probability of receiving RHC") +
theme_bw()
glm_df %>%
mutate(RHC = ifelse(RHC == 1, "RHC", "No RHC")) %>%
ggplot(aes(x = p_rhc)) +
geom_histogram(color = "white") +
facet_wrap(~RHC,color = factor(RHC)) +
xlab("Probability of receiving RHC") +
theme_bw()
glm_df %>%
mutate(RHC = ifelse(RHC == 1, "RHC", "No RHC")) %>%
ggplot(aes(x = p_rhc)) +
geom_histogram(color = "white") +
facet_wrap(~RHC) +
xlab("Probability of receiving RHC") +
theme_bw()
rhc_psm_df %>%
mutate(RHC = ifelse(RHC == 1, "RHC", "No RHC")) %>%
ggplot(aes(x = distance)) +
geom_histogram(color = "white") +
facet_wrap(~RHC) +
xlab("Probability of receiving RHC") +
theme_bw()
knitr::opts_chunk$set(echo = TRUE)
knitr::opts_chunk$set(message = F)
knitr::opts_chunk$set(warning = F)
library(tableone)
library(tidyverse)
library(survival)
library(survminer)
library(GGally)
library(survRM2)
library(knitr)
library(kableExtra)
#library(randomForestSRC)
library(ggRandomForests)
library(pROC)
#library(grpreg)
#library(pec)
library(ggfortify)
library(broom)
library(finalfit)
library(MatchIt)
knitr::opts_chunk$set(echo = TRUE)
knitr::opts_chunk$set(message = F)
knitr::opts_chunk$set(warning = F)
library(tableone)
library(tidyverse)
library(survival)
library(survminer)
library(GGally)
library(survRM2)
library(knitr)
library(kableExtra)
#library(randomForestSRC)
library(ggRandomForests)
library(pROC)
#library(grpreg)
#library(pec)
library(ggfortify)
library(broom)
library(finalfit)
library(MatchIt)
file <- "http://biostat.mc.vanderbilt.edu/wiki/pub/Main/DataSets/rhc.csv"
rhc <- read_csv(file)
rhc_df <-
rhc %>%
select(age = age,
sex = sex,
race = race,
education = edu,
income = income,
med_ins = ninsclas,
disease = cat1,
cancer = ca,
weight = wtkilo1,
temp = temp1,
bp = meanbp1,
resp = resp1,
hrt = hrt1,
pf = pafi1,
pc = paco21,
ph = ph1,
death = dth30,
time = t3d30,
RHC = swang1)
#summary(rhc_df)
CreateTableOne(data = rhc_df, strata = 'RHC') %>%
print() -> tblprint
tblprint[c(3,4, 9, 14, 21, 31, 43,45),4] <- 'Chi-sq'
kable(tblprint , "html", caption = "Stritified by Right Heart Catheterization", booktabs = T) %>%
kable_styling('responsive') %>%
add_indent(c(5:7, 10:13,15:20,22:30,32:34))
p1 <- rhc_df %>%
ggplot(aes(x = RHC, fill = sex)) +
geom_bar() + ggtitle('distribution of RHC')
p2 <- rhc_df %>%
ggplot(aes(x = RHC, fill = race)) +
geom_bar(position = "fill") +
ggtitle('distribution of RHC') +
ylab('proportion')
p3 <- rhc_df %>%
ggplot(aes(x = RHC, fill = med_ins)) +
geom_bar(position = "fill") +
ggtitle('distribution of RHC') +
ylab('proportion')
ggarrange(p1, p2, p3, ncol=3, nrow=1)
p4 <- rhc_df %>%
ggplot(aes(x = RHC, y = age, color = RHC)) +
geom_boxplot() + ggtitle('distribution of age')
p5 <- rhc_df %>%
ggplot(aes(x = RHC, y = bp, color = RHC)) +
geom_boxplot() + ggtitle('distribution of blood pressure')
p6 <- rhc_df %>%
ggplot(aes(x = RHC, y = pf, color = RHC)) +
geom_boxplot() + ggtitle('distribution of PaO2/FiO2')
ggarrange(p4, p5,p6, ncol=3, nrow=1)
rhc_df$death <- as.numeric(as.factor(rhc_df$death)) -1
rhc_df$RHC <- as.numeric(as.factor(rhc_df$RHC)) - 1
fit <- survfit(Surv(time, death) ~ RHC, data = rhc_df)
fit
res.sum <- surv_summary(fit)
autoplot(fit, conf.int = FALSE) +
labs(title = 'Kaplan Meier Plot',
y = 'survival probability', color = 'RHC', fill = 'RHC') +
theme_bw() +
scale_color_manual(labels = c("No RHC", "RHC"), values = c("red", "blue"))
rmst <- rmst2(rhc_df$time, rhc_df$death, arm = rhc_df$RHC, tau = 30, covariates = NULL)
rmst$unadjusted.result %>%
tidy() -> tbl.rmst
tbl.rmst %>%
mutate(CI = paste('(',signif(lower..95,3), ',',signif(upper..95,3),')')) -> tbl.rmst
tbl.rmst <- tbl.rmst[,c(1,2,6,5)]
colnames(tbl.rmst) <- c('Comparision', 'Estiamte', '95% CI', 'P-value')
tbl.rmst$`P-value`[tbl.rmst$`P-value` < 0.001] <- '<0.001'
tbl.rmst$Estiamte <- signif(tbl.rmst$Estiamte, 3)
kable(tbl.rmst[c(1,2),], "html", caption = "Restricted mean survival time", booktabs = T) %>%
kable_styling('responsive')
psm_glm <- glm(RHC ~ .-RHC-time-death, family = binomial(link = "logit"),
data = rhc_df)
glm_df <- data.frame( p_rhc <-  predict(psm_glm, type = "response"),
# Predicted probability of being assigned to RHC
p_norhc <-  1 - p_rhc,
# Predicted probability of being assigned to no RHC
RHC <-  psm_glm$model$RHC)
glm_df %>%
mutate(RHC = ifelse(RHC == 1, "RHC", "No RHC")) %>%
ggplot(aes(x = p_rhc)) +
geom_histogram(color = "white") +
facet_wrap(~RHC) +
xlab("Probability of receiving RHC") +
theme_bw()
epsilon <- 0.2*sd(log(p_rhc/(1-p_rhc)))
psm_mod <- matchit(RHC ~ age + sex + race + education +
income + med_ins + disease + cancer +
weight + temp + bp + resp + hrt + pf +
pc + ph, data = rhc_df, method = "nearest",
caliper  = epsilon, ratio = 1)
rhc_psm_df <- match.data(psm_mod)
#head(rhc_psm_df)
rhc_psm_df %>%
mutate(RHC = ifelse(RHC == 1, "RHC", "No RHC")) %>%
ggplot(aes(x = distance)) +
geom_histogram(color = "white") +
facet_wrap(~RHC) +
xlab("Probability of receiving RHC") +
theme_bw()
plot(psm_mod,type = "hist" )
